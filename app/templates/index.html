<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Planner ‚Äì Your Weekly Menu Made Easy</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Weekly meal planning with shopping list generation">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Meals">

    <!-- CSRF token for AJAX requests -->
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">

    <!-- Favicon and Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <link rel="apple-touch-icon" href="/static/icon-192.png">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primary: #059669;
            --color-primary-dark: #047857;
            --color-primary-light: #d1fae5;
            --color-accent: #f97316;
            --color-accent-light: #fed7aa;
            --color-background: #fafaf9;
            --color-surface: #ffffff;
            --color-text: #1c1917;
            --color-text-light: #57534e;
            --color-text-muted: #a8a29e;
            --color-border: #e7e5e4;
            --color-error: #dc2626;
            --color-success: #059669;
            --color-warning: #f59e0b;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;

            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--color-text);
            background: linear-gradient(135deg, #fafaf9 0%, #f5f5f4 50%, #fef3c7 100%);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-bottom: 60px; /* reserve space for bottom tab bar */
        }

        /* Sidebar ‚Äî desktop only */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 240px;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            display: none;
            flex-direction: column;
            z-index: 100;
            padding: 1.5rem 0;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0 1.25rem 1.5rem;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1rem;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.375rem;
            flex-shrink: 0;
        }

        .sidebar-logo-text {
            font-family: 'Crimson Pro', serif;
            font-size: 1.375rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0 0.75rem;
        }

        .sidebar-nav .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            color: var(--color-text-light);
            font-size: 0.9375rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .sidebar-nav .nav-link:hover {
            background: var(--color-primary-light);
            color: var(--color-primary);
        }

        .sidebar-nav .nav-link.active {
            background: var(--color-primary-light);
            color: var(--color-primary);
            font-weight: 600;
        }

        /* Bottom tab bar ‚Äî mobile only */
        .bottom-tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
            display: flex;
            z-index: 100;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            font-size: 0.6875rem;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: var(--transition);
            border: none;
            background: none;
            text-decoration: none;
            padding: 0.25rem 0;
        }

        .tab-item span:first-child {
            font-size: 1.25rem;
        }

        .tab-item.active {
            color: var(--color-primary);
        }

        .tab-item:hover {
            color: var(--color-primary);
        }

        /* Desktop layout adjustments */
        @media (min-width: 1024px) {
            .sidebar { display: flex; }
            .main-content { margin-left: 240px; }
            .bottom-tab-bar { display: none; }
            body { padding-bottom: 0; }
        }

        /* FAB */
        .fab-container {
            position: fixed;
            bottom: 80px;
            right: 1.5rem;
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--color-primary);
            color: white;
            font-size: 1.75rem;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            line-height: 1;
        }

        .fab:hover {
            background: var(--color-primary-dark);
            transform: scale(1.05);
        }

        .fab-icon {
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .fab-container.fab-open .fab-icon {
            transform: rotate(45deg);
        }

        .fab-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .fab-container.fab-open .fab-options {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .fab-option {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 0.625rem 1rem;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            white-space: nowrap;
            transition: var(--transition);
        }

        .fab-option:hover {
            background: var(--color-primary-light);
            color: var(--color-primary);
            border-color: var(--color-primary-light);
        }

        @media (min-width: 1024px) {
            .fab-container { bottom: 1.5rem; }
        }

        /* Settings section */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .settings-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (min-width: 1200px) {
            .settings-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .settings-card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
        }

        .settings-card h3 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--color-text);
        }

        .settings-card label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-light);
            margin-bottom: 0.375rem;
        }

        .settings-card input[type="number"],
        .settings-card input[type="text"] {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: var(--color-background);
            margin-bottom: 1rem;
            font-family: inherit;
        }

        .settings-card input:focus {
            outline: 2px solid var(--color-primary);
            border-color: var(--color-primary);
        }

        .excluded-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.6rem;
            background: var(--color-primary-light);
            color: var(--color-primary);
            border-radius: 999px;
            font-size: 0.8125rem;
            font-weight: 500;
        }
        .excluded-tag button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-primary);
            font-size: 0.9rem;
            line-height: 1;
            padding: 0;
            opacity: 0.7;
        }
        .excluded-tag button:hover { opacity: 1; }

        /* Shopping list normalization loading state */
        .shopping-loading {
            padding: 1.25rem 0.5rem;
        }
        .shopping-loading-msg {
            font-size: 0.9375rem;
            color: var(--color-text-muted);
            text-align: center;
            margin-bottom: 1.25rem;
            transition: opacity 0.3s;
        }
        .skeleton-shopping {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }
        .skeleton-item {
            height: 2.75rem;
            border-radius: var(--radius-md);
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.4s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%   { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Header */
        .header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--color-text);
            line-height: 1;
        }

        .logo-text p {
            font-size: 0.875rem;
            color: var(--color-text-muted);
            margin-top: 0.125rem;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            border-radius: var(--radius-xl);
            padding: 3rem;
            margin-bottom: 3rem;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .hero h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .hero p {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: 2rem;
            max-width: 600px;
        }

        .hero-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            min-height: 44px;
            white-space: nowrap;
        }

        .btn-primary {
            background: white;
            color: var(--color-primary);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-accent {
            background: var(--color-accent);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-accent:hover {
            background: #ea580c;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--color-border);
            color: var(--color-text);
        }

        .btn-outline:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-icon {
            font-size: 1.25rem;
        }

        /* Section */
        .section {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.875rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .section-subtitle {
            color: var(--color-text-muted);
            font-size: 0.9375rem;
            margin-top: 0.25rem;
        }

        /* Cards */
        .card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary-light);
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        /* Week Calendar */
        .week-calendar {
            display: grid;
            gap: 1rem;
            position: relative;
        }

        /* Landscape mode: Show all days in a grid */
        @media (min-width: 768px) and (orientation: landscape), (min-width: 1024px) {
            .week-calendar {
                grid-template-columns: repeat(7, minmax(0, 1fr));
            }

            .calendar-nav {
                display: none;
            }

            .day-card {
                display: block !important;
            }
        }

        /* Portrait mode: Show one day at a time */
        @media (max-width: 767px), (max-width: 1023px) and (orientation: portrait) {
            .week-calendar {
                grid-template-columns: 1fr;
                overflow: hidden;
            }

            .day-card {
                display: none;
            }

            .day-card.active {
                display: block;
                animation: slideIn 0.3s ease-out;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateX(20px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
        }

        /* Calendar Navigation Controls */
        .calendar-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            border: 1px solid var(--color-border);
        }

        .calendar-nav-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.25rem;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .calendar-nav-btn:hover:not(:disabled) {
            background: var(--color-primary-dark);
            transform: scale(1.05);
        }

        .calendar-nav-btn:disabled {
            background: var(--color-border);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .calendar-nav-center {
            flex: 1;
            text-align: center;
            padding: 0 1rem;
        }

        .calendar-current-day {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 0.25rem;
        }

        .calendar-day-progress {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-border);
            transition: var(--transition);
        }

        .progress-dot.active {
            background: var(--color-primary);
            width: 10px;
            height: 10px;
        }

        .swipe-hint {
            text-align: center;
            color: var(--color-text-light);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            opacity: 0;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .day-card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--color-border);
            transition: var(--transition);
        }

        .day-card:hover {
            box-shadow: var(--shadow-md);
        }

        .day-header {
            background: linear-gradient(135deg, var(--color-primary-light) 0%, #d1fae5 100%);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            min-width: 0;
        }

        .day-header.over-limit {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
        }

        .day-name {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--color-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .day-calories {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--color-text-light);
            flex-shrink: 0;
        }

        .calorie-badge {
            background: white;
            padding: 0.2rem 0.5rem;
            border-radius: 999px;
            font-weight: 500;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .day-meals {
            padding: 0.625rem;
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            grid-auto-rows: 1fr;
            gap: 0.375rem;
        }

        /* ‚îÄ‚îÄ Meal slot (both empty and filled) ‚îÄ‚îÄ */
        .meal-slot {
            border-radius: var(--radius-sm);
            border: 1.5px dashed var(--color-border);
            transition: border-color 0.15s, background 0.15s;
            min-width: 0;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: 7rem;
        }

        .meal-slot.has-meal {
            border-style: solid;
            border-color: var(--color-primary-light);
            background: white;
            cursor: default;
        }

        .meal-slot:not(.has-meal):hover {
            border-color: var(--color-primary);
            background: #f0fdf8;
        }

        .meal-slot.has-meal:hover {
            border-color: var(--color-primary);
        }

        /* ‚îÄ‚îÄ Header row (meal type label + action buttons) ‚îÄ‚îÄ */
        .meal-slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0.5rem 0.25rem;
            gap: 0.25rem;
        }

        .meal-type {
            text-transform: uppercase;
            font-size: 0.6rem;
            font-weight: 700;
            letter-spacing: 0.07em;
            color: var(--color-text-muted);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .meal-actions {
            display: flex;
            gap: 0.1rem;
            flex-shrink: 0;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .meal-slot:hover .meal-actions {
            opacity: 1;
        }

        /* Always visible on touch devices */
        @media (hover: none) {
            .meal-actions { opacity: 1; }
        }

        .btn-icon {
            width: 18px;
            height: 18px;
            padding: 0;
            border: none;
            border-radius: 3px;
            background: transparent;
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background 0.12s, color 0.12s;
        }

        .btn-icon:hover {
            background: var(--color-primary-light);
            color: var(--color-primary);
        }

        .btn-icon.btn-danger:hover {
            background: #fee2e2;
            color: var(--color-error);
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8125rem;
            border-radius: var(--radius-sm);
            min-height: 28px;
        }

        /* ‚îÄ‚îÄ Filled slot: image area (fills flex:1 space) ‚îÄ‚îÄ */
        .meal-image-area {
            flex: 1;
            overflow: hidden;
            position: relative;
            min-height: 0;
        }

        .meal-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .meal-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        }

        /* ‚îÄ‚îÄ Filled slot: footer (name + nutrition) ‚îÄ‚îÄ */
        .meal-slot-footer {
            padding: 0.3rem 0.5rem 0.375rem;
            border-top: 1px solid var(--color-border);
            background: white;
        }

        .meal-name {
            font-weight: 600;
            font-size: 0.6875rem;
            color: var(--color-text);
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .meal-name a {
            color: inherit;
            text-decoration: none;
        }

        .meal-name a:hover {
            color: var(--color-primary);
        }

        .meal-nutrition {
            display: flex;
            flex-wrap: wrap;
            gap: 0.1rem 0.25rem;
            font-size: 0.5625rem;
            color: var(--color-text-light);
            margin-top: 0.1rem;
        }

        .meal-nutrition span {
            white-space: nowrap;
        }

        /* ‚îÄ‚îÄ Empty slot body ‚îÄ‚îÄ */
        .empty-slot {
            display: flex;
            flex: 1;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0.5rem 0.5rem;
            cursor: pointer;
        }

        .empty-slot:hover .empty-slot-plus-btn {
            border-color: var(--color-primary);
            color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .empty-slot-plus-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: transparent;
            color: var(--color-text-muted);
            border: 1.5px dashed var(--color-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            padding: 0;
        }


        .meal-hidden-warning {
            background: #fffbeb;
            border-top: 1px solid #fcd34d;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        /* Recipe List */
        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .recipe-card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--color-border);
            transition: var(--transition);
            cursor: pointer;
        }

        .recipe-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }

        .recipe-image {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, var(--color-primary-light) 0%, var(--color-accent-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            object-fit: cover;
            position: relative;
            overflow: hidden;
        }

        .recipe-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .recipe-image-emoji {
            font-size: 4rem;
        }

        .recipe-content {
            padding: 1.25rem;
        }

        .recipe-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            color: var(--color-text);
        }

        .recipe-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--color-text-light);
            margin-bottom: 0.75rem;
        }

        .recipe-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            background: var(--color-primary-light);
            color: var(--color-primary-dark);
            padding: 0.25rem 0.625rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Tag Filter Buttons */
        .tag-filter {
            padding: 0.375rem 0.875rem;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text);
            cursor: pointer;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .tag-filter:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .tag-filter.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Clear All Button */
        .clear-all-btn {
            padding: 0.375rem 0.875rem;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .clear-all-btn:hover {
            border-color: var(--color-error);
            color: var(--color-error);
            background: #fee;
        }

        /* Shopping List */
        .shopping-list {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--color-border);
        }

        .shopping-category {
            margin-bottom: 1.5rem;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--color-border);
        }

        .category-icon {
            font-size: 1.5rem;
        }

        .category-name {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--color-text);
        }

        .shopping-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 0.5rem;
        }

        .shopping-item {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.5rem 0.75rem;
            background: var(--color-background);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .shopping-item:hover {
            background: var(--color-primary-light);
        }

        .shopping-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }

        .shopping-item.checked {
            opacity: 0.5;
        }

        .shopping-item.checked .item-text {
            text-decoration: line-through;
        }

        .item-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
            min-width: 0;
        }

        .item-text {
            color: var(--color-text);
        }

        .item-sources {
            font-size: 0.72rem;
            color: var(--color-text-secondary, #888);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .shopping-item.checked .item-sources {
            text-decoration: line-through;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: var(--transition);
        }

        .shopping-item:hover .item-actions {
            opacity: 1;
        }

        .item-action-btn {
            background: none;
            border: none;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 1.125rem;
            transition: var(--transition);
            border-radius: var(--radius-sm);
        }

        .item-action-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .item-edit-mode {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .item-edit-input {
            padding: 0.375rem 0.5rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            background: white;
        }

        .item-edit-input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .item-quantity-input {
            width: 60px;
        }

        .item-name-input {
            flex: 1;
            min-width: 120px;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        .hidden {
            display: none !important;
        }

        .modal.hidden {
            display: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-xl);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 2rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--color-background);
            color: var(--color-text);
        }

        .modal-body {
            padding: 2rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--color-border);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            color: var(--color-text-muted);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .tab:hover {
            color: var(--color-text);
            background: var(--color-background);
        }

        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--color-text);
        }

        input[type="text"],
        input[type="url"],
        input[type="number"],
        input[type="file"],
        textarea,
        select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
            background: var(--color-surface);
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-light);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-hint {
            font-size: 0.875rem;
            color: var(--color-text-muted);
            margin-top: 0.5rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
            font-size: 0.9375rem;
            line-height: 1.5;
        }

        .status-message.success {
            background: var(--color-primary-light);
            color: var(--color-primary-dark);
            border-left: 4px solid var(--color-primary);
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--color-error);
        }

        .status-message.warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--color-warning);
        }

        .status-message.hidden {
            display: none;
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, var(--color-primary-light) 0%, #dbeafe 100%);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--color-primary);
        }

        .info-box-title {
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-box-content {
            font-size: 0.9375rem;
            color: var(--color-text-light);
            line-height: 1.6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header-content {
                padding: 1rem;
            }

            .hero {
                padding: 2rem 1.5rem;
            }

            .hero h2 {
                font-size: 1.875rem;
            }

            .hero-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .recipe-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-width: 100%;
                border-radius: var(--radius-lg);
            }

            .form-actions {
                flex-direction: column;
            }

            /* Recipe Filter Responsive Styles */
            .recipe-filters > div:first-child {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }

            .recipe-filters select {
                width: 100%;
            }

            .recipe-filters input {
                font-size: 16px !important; /* Prevent iOS zoom on focus */
            }

            /* Tag filters with better touch targets */
            .tag-filter,
            .clear-all-btn {
                padding: 0.625rem 1rem;
                font-size: 0.9375rem;
                min-height: 44px; /* iOS recommended touch target */
            }

            /* Pagination responsive */
            #recipePagination {
                flex-wrap: wrap;
                gap: 0.375rem !important;
            }

            #recipePagination button {
                min-width: 44px;
                min-height: 44px;
                padding: 0.5rem;
            }

            #recipePagination span {
                padding: 0 0.25rem !important;
            }

            /* Hide page number ellipsis on very small screens */
            @media (max-width: 480px) {
                #recipePagination button:not(.btn-primary):not(:first-child):not(:last-child) {
                    display: none;
                }

                #recipePagination span {
                    display: none;
                }
            }

            /* Recipe cards already single column, ensure proper spacing */
            .recipe-card {
                margin-bottom: 0;
            }

            /* Adjust quick stats grid on mobile */
            .grid-3 {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
        }

        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 0.5rem;
        }

        .empty-state-text {
            color: var(--color-text-muted);
            margin-bottom: 2rem;
        }

        .cook-once-badge { display: inline-block; font-size: 0.65rem; font-weight: 600;
          padding: 1px 6px; border-radius: 999px; margin-left: 4px; }
        .cook-once-badge.reheat  { background: #fef3c7; color: #92400e; }
        .cook-once-badge.pack    { background: #dbeafe; color: #1e40af; }
        .cook-once-badge.no-cook    { background: #fef3c7; color: #92400e; }
        .cook-once-badge.cook-ahead { background: #ede9fe; color: #5b21b6; }
        .meal-slot.meal-derived  { border-left: 3px solid #fbbf24; }
        .cook-mode-btn { background: none; border: 1px solid var(--border); border-radius: 6px;
          cursor: pointer; padding: 2px 6px; font-size: 0.9rem; }
        .cook-mode-btn[data-can-cook="true"]  { background: #d1fae5; border-color: #6ee7b7; }
        .cook-mode-btn[data-can-cook="false"] { background: #fef3c7; border-color: #fbbf24; }
        .cook-mode-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    </style>
</head>
<body>
    <!-- Sidebar (desktop) -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <span class="sidebar-logo-icon">üç≥</span>
            <span class="sidebar-logo-text">Meal Planner</span>
        </div>
        <nav class="sidebar-nav">
            <a class="nav-link active" data-section="plan" onclick="scrollToSection('plan')">üìã Plan</a>
            <a class="nav-link" data-section="recipes" onclick="scrollToSection('recipes')">ü•ó Recipes</a>
            <a class="nav-link" data-section="shopping" onclick="scrollToSection('shopping')">üõí Shopping</a>
            <a class="nav-link" data-section="settings" onclick="scrollToSection('settings')">‚öôÔ∏è Settings</a>
        </nav>
    </aside>

    <div class="main-content">
    <!-- Main Container -->
    <div class="container">
        <!-- Welcome banner (shown only when no plan exists) -->
        {% if not current_plan %}
        <section class="hero" id="welcome-banner">
            <div class="hero-content">
                <h2>Your Weekly Menu, Simplified</h2>
                <p>Import recipes, plan your week, and generate shopping lists automatically. Use the + button to add recipes.</p>
            </div>
        </section>
        {% endif %}

        <!-- Quick Stats -->
        {% if current_plan %}
        {% set fresh_meals = current_plan.meals | selectattr("meal_source", "equalto", "fresh") | list %}
        {% set cook_sessions = fresh_meals | length %}
        <div class="grid grid-4" style="margin-bottom: 3rem;">
            <div class="card">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; background: var(--color-primary-light); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üìã</div>
                    <div>
                        <div style="font-size: 0.875rem; color: var(--color-text-muted);">This Week</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-text);">{{ current_plan.meals|length }} Meals</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; background: var(--color-accent-light); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üî•</div>
                    <div>
                        <div style="font-size: 0.875rem; color: var(--color-text-muted);">Avg Daily</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-text);">{{ current_plan.daily_averages.calories|int }} cal</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; background: #dbeafe; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üõí</div>
                    <div>
                        <div style="font-size: 0.875rem; color: var(--color-text-muted);">Shopping Items</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-text);">{{ current_shopping_list.items|length if current_shopping_list else 0 }}</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; background: #fef3c7; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üç≥</div>
                    <div>
                        <div style="font-size: 0.875rem; color: var(--color-text-muted);">Recipes to Cook</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-text);">{{ cook_sessions }} recipes</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Weekly Plan Section -->
        <section class="section" id="plan">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Weekly Plan</h2>
                    <p class="section-subtitle" id="scheduleInfo">Configure your schedule in Settings</p>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button id="generateBtn" class="btn btn-accent" onclick="generatePlan()">
                        <span class="btn-icon">üé≤</span>
                        Generate Plan
                    </button>
                    <button class="btn btn-outline" onclick="clearWeek()">
                        <span class="btn-icon">üóëÔ∏è</span>
                        Clear Week
                    </button>
                </div>
            </div>

            <!-- Mobile/Portrait Navigation -->
            <div id="calendarNav" class="calendar-nav" style="display: none;">
                <button id="prevDayBtn" class="calendar-nav-btn" onclick="navigateDay(-1)">
                    ‚Äπ
                </button>
                <div class="calendar-nav-center">
                    <div id="currentDayName" class="calendar-current-day"></div>
                    <div id="dayProgress" class="calendar-day-progress"></div>
                </div>
                <button id="nextDayBtn" class="calendar-nav-btn" onclick="navigateDay(1)">
                    ‚Ä∫
                </button>
            </div>
            <div id="swipeHint" class="swipe-hint">Swipe left or right to navigate days</div>

            <div id="weeklyCalendar" class="week-calendar">
                <!-- Calendar will be rendered by JavaScript -->
            </div>
        </section>

        <!-- Shopping List Section -->
        <section class="section" id="shopping">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Shopping List</h2>
                    <p class="section-subtitle" id="shoppingListSubtitle">
                        {% if current_shopping_list %}
                            {{ current_shopping_list.items|length }} ingredient{{ 's' if current_shopping_list.items|length != 1 else '' }} across {{ current_shopping_list.items | map(attribute='category') | unique | list | length }} categor{{ 'ies' if current_shopping_list.items | map(attribute='category') | unique | list | length != 1 else 'y' }}
                        {% else %}
                            Generate a meal plan to create a shopping list
                        {% endif %}
                    </p>
                </div>
                <div id="shoppingListActions" style="display: {% if current_shopping_list %}flex{% else %}none{% endif %}; gap: 0.75rem;">
                    <button class="btn btn-primary" onclick="openAddItemModal()">
                        <span class="btn-icon">+</span>
                        Add Item
                    </button>
                    <button class="btn btn-outline" onclick="uncheckAllShoppingItems()">
                        Reset Checks
                    </button>
                </div>
            </div>

            <div id="shoppingListContainer" class="shopping-list" style="display: {% if current_shopping_list %}block{% else %}none{% endif %};">
                <!-- Will be rendered by JavaScript -->
            </div>
        </section>

        <!-- Recipe Library Section -->
        <section class="section" id="recipes">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Recipe Library</h2>
                    <p class="section-subtitle" id="recipeCount">Loading recipes...</p>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="recipe-filters" style="margin-bottom: 2rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: 1.25rem;">
                <!-- Search Bar -->
                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem; align-items: center;">
                    <div style="flex: 1; position: relative;">
                        <span style="position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); font-size: 1rem; pointer-events: none;">üîç</span>
                        <input
                            type="text"
                            id="recipeSearch"
                            placeholder="Search by name, ingredient, or tag..."
                            style="width: 100%; padding: 0.75rem 2.5rem 0.75rem 2.5rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem; background: var(--color-background);"
                        >
                        <button
                            id="clearSearch"
                            onclick="clearSearch()"
                            style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--color-text-muted); cursor: pointer; padding: 0.25rem; display: none; font-size: 1rem;"
                        >‚úï</button>
                    </div>
                    <select
                        id="recipeSort"
                        onchange="applyFilters()"
                        style="padding: 0.75rem 1rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 0.9375rem; background: var(--color-background); width: 200px; flex-shrink: 0;"
                    >
                        <option value="">Sort by...</option>
                        <option value="name_asc">Name (A‚ÄìZ)</option>
                        <option value="name_desc">Name (Z‚ÄìA)</option>
                        <option value="calories_asc">Calories ‚Üë</option>
                        <option value="calories_desc">Calories ‚Üì</option>
                        <option value="time_asc">Time ‚Üë (Quick first)</option>
                        <option value="time_desc">Time ‚Üì (Long first)</option>
                    </select>
                </div>

                <!-- Tag Filters -->
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                    <span style="color: var(--color-text-muted); font-size: 0.875rem; line-height: 2rem;">Quick filters:</span>
                    <button class="tag-filter" data-tag="quick" onclick="toggleTagFilter(this)">‚ö° Quick</button>
                    <button class="tag-filter" data-tag="vegetarian" onclick="toggleTagFilter(this)">ü•¨ Vegetarian</button>
                    <button class="tag-filter" data-tag="vegan" onclick="toggleTagFilter(this)">üå± Vegan</button>
                    <button class="tag-filter" data-tag="italian" onclick="toggleTagFilter(this)">üçù Italian</button>
                    <button class="tag-filter" data-tag="mexican" onclick="toggleTagFilter(this)">üåÆ Mexican</button>
                    <button class="tag-filter" data-tag="asian" onclick="toggleTagFilter(this)">üçú Asian</button>
                    <button class="tag-filter" data-tag="breakfast" onclick="toggleTagFilter(this)">ü•û Breakfast</button>
                    <button class="tag-filter" data-tag="dessert" onclick="toggleTagFilter(this)">üç∞ Dessert</button>
                    <button class="tag-filter" data-tag="salad" onclick="toggleTagFilter(this)">ü•ó Salad</button>
                    <button class="clear-all-btn" onclick="clearAllTags()">Clear All</button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="recipeLoading" style="text-align: center; padding: 3rem; display: none;">
                <div style="font-size: 3rem;">‚è≥</div>
                <p style="color: var(--color-text-muted); margin-top: 1rem;">Loading recipes...</p>
            </div>

            <!-- Empty State -->
            <div id="recipeEmpty" style="display: none;">
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <h3 class="empty-state-title">No recipes found</h3>
                    <p class="empty-state-text">Try adjusting your search or filters</p>
                    <button class="btn btn-outline" onclick="resetFilters()">Clear Filters</button>
                </div>
            </div>

            <!-- Recipe Grid (populated by JavaScript) -->
            <div id="recipeGrid" class="recipe-grid"></div>

            <!-- Pagination -->
            <div id="recipePagination" style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 2rem;"></div>
        </section>

        <!-- Settings Section -->
        <section class="section" id="settings">
            <div class="section-header">
                <div><h2 class="section-title">Settings</h2></div>
            </div>

            <div class="settings-grid">
                <!-- Meal Schedule card -->
                <div class="settings-card" style="grid-column: 1 / -1;">
                    <h3>Meal Schedule</h3>
                    <div id="settingsScheduleFormContent" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));"></div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="saveScheduleSettings()">Save Schedule</button>
                    </div>
                </div>

                <!-- Household card -->
                <div class="settings-card">
                    <h3>Household</h3>
                    <label>Total Portions</label>
                    <input type="number" id="settingsPortions" min="0.5" step="0.25" value="{{ household_portions }}">
                    <label>Daily Calorie Limit</label>
                    <input type="number" id="settingsCalorieLimit" min="500" step="50" value="{{ current_plan.daily_calorie_limit if current_plan and current_plan.daily_calorie_limit else 1600 }}">
                    <label>Max times same recipe appears</label>
                    <p style="color: var(--color-text-muted); font-size: 0.8rem; margin: -0.25rem 0 0.5rem;">Includes the original cook plus any leftovers/packed lunches. <strong>1</strong> = cook once, eat once. <strong>2</strong> = cook once, eat twice (recommended). <strong>3</strong> = cook once, eat three times.</p>
                    <input type="number" id="settingsMaxDerived" min="1" max="3" step="1" value="{{ config.COOK_ONCE_MAX_DERIVED }}">
                    <button class="btn btn-primary" onclick="saveHouseholdSettings()">Save</button>
                </div>

                <!-- Visible Meals card -->
                <div class="settings-card">
                    <h3>Visible Meals</h3>
                    <p style="color: var(--color-text-muted); font-size: 0.875rem; margin-bottom: 1rem;">Choose which meal types appear in the weekly calendar.</p>
                    <div style="display: grid; gap: 0.625rem;" id="visibleMealsToggles"></div>
                    <button class="btn btn-primary" style="margin-top: 1rem;" onclick="saveVisibleMeals()">Save</button>
                </div>

                <!-- Excluded Ingredients card -->
                <div class="settings-card">
                    <h3>Excluded Ingredients</h3>
                    <p style="color: var(--color-text-muted); font-size: 0.875rem; margin-bottom: 1rem;">Ingredients that will never appear in the shopping list (e.g. water, salt).</p>
                    <div id="excludedTagsList" style="display: flex; flex-wrap: wrap; gap: 0.375rem; margin-bottom: 0.75rem;"></div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="excludedIngredientInput" placeholder="Add ingredient‚Ä¶"
                               style="flex: 1;"
                               onkeydown="if(event.key==='Enter'){event.preventDefault();addExcludedIngredient();}">
                        <button class="btn btn-outline" onclick="addExcludedIngredient()">Add</button>
                    </div>
                </div>
            </div>
        </section>
    </div><!-- /.container -->
    </div><!-- /.main-content -->

    <!-- Import Modal -->
    <div id="importModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Import Recipe</h2>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="switchImportTab('url')">üîó From URL</button>
                    <button class="tab" onclick="switchImportTab('text')">üìù From Text</button>
                    <button class="tab" onclick="switchImportTab('photo')">üì∑ From Photo</button>
                </div>

                <!-- URL Import Form -->
                <form id="importRecipeForm" onsubmit="handleImportFormSubmit(event)">
                    <div class="form-group">
                        <label for="recipeUrl">Recipe URL</label>
                        <input type="url" id="recipeUrl" placeholder="https://example.com/recipe or Instagram URL" required>
                        <p class="form-hint">Supports recipe websites and Instagram posts</p>
                    </div>

                    <div id="importStatus" class="status-message hidden"></div>

                    <div class="form-actions">
                        <button type="submit" id="importBtn" class="btn btn-primary" style="flex: 1;">Import Recipe</button>
                        <button type="button" class="btn btn-outline" onclick="closeImportModal()">Cancel</button>
                    </div>
                </form>

                <!-- Text Import Form -->
                <form id="importTextForm" class="hidden" onsubmit="handleTextImportFormSubmit(event)">
                    <div class="form-group">
                        <label for="recipeText">Recipe Text</label>
                        <textarea id="recipeText" placeholder="Paste the recipe text here..." rows="8" required></textarea>
                        <p class="form-hint">Paste Instagram post text, recipe from email, or any recipe text. AI will extract the structured data.</p>
                    </div>

                    <div id="importTextStatus" class="status-message hidden"></div>

                    <div class="form-actions">
                        <button type="submit" id="importTextBtn" class="btn btn-primary" style="flex: 1;">Import from Text</button>
                        <button type="button" class="btn btn-outline" onclick="closeImportModal()">Cancel</button>
                    </div>
                </form>

                <!-- Photo Import Form -->
                <form id="importPhotoForm" class="hidden" onsubmit="handlePhotoImportFormSubmit(event)">
                    <div class="form-group">
                        <label for="recipePhoto">Recipe Photo</label>
                        <input type="file" id="recipePhoto" accept="image/*" capture="environment" required>
                        <p class="form-hint">Take a photo or upload an image of a recipe card, cookbook page, or handwritten recipe.</p>
                    </div>

                    <div id="photoPreview" style="display: none; margin-top: 1rem;">
                        <img id="photoPreviewImg" style="max-width: 100%; border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                    </div>

                    <div id="importPhotoStatus" class="status-message hidden"></div>

                    <div class="form-actions">
                        <button type="submit" id="importPhotoBtn" class="btn btn-primary" style="flex: 1;">Import from Photo</button>
                        <button type="button" class="btn btn-outline" onclick="closeImportModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Schedule Configuration Modal -->
    <!-- Add Shopping Item Modal -->
    <div id="addItemModal" class="modal hidden">
        <div class="modal-content" style="max-width: 460px;">
            <div class="modal-header">
                <h2 class="modal-title">Add Item</h2>
                <button class="modal-close" onclick="closeAddItemModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addItemForm" onsubmit="submitAddItemForm(event)" style="display: grid; gap: 1rem;">
                    <div class="form-group">
                        <label for="addItemName">Item name <span style="color:var(--color-danger)">*</span></label>
                        <input type="text" id="addItemName" placeholder="e.g. Cherry tomatoes" autocomplete="off" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="addItemQuantity">Quantity</label>
                            <input type="number" id="addItemQuantity" value="1" min="0.1" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="addItemUnit">Unit</label>
                            <input type="text" id="addItemUnit" placeholder="e.g. kg, ml, bunch">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="addItemCategory">Category</label>
                        <select id="addItemCategory">
                            <option value="produce">ü•¶ Produce</option>
                            <option value="meat">ü•© Meat</option>
                            <option value="seafood">üêü Seafood</option>
                            <option value="dairy">üßÄ Dairy &amp; Eggs</option>
                            <option value="grains">üåæ Grains &amp; Bread</option>
                            <option value="spices">üå∂Ô∏è Spices &amp; Herbs</option>
                            <option value="pantry">ü´ô Pantry</option>
                            <option value="other" selected>üõí Other</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Add to List</button>
                        <button type="button" class="btn btn-outline" onclick="closeAddItemModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="scheduleModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Configure Weekly Schedule</h2>
                <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <div class="info-box-title">
                        <span>üí°</span>
                        How it works
                    </div>
                    <div class="info-box-content">
                        Set which meals you need each day and how many servings. This tells the generator what to plan for your week.
                    </div>
                </div>
                <div id="scheduleConfigForm" style="display: grid; gap: 1rem;"></div>
                <div class="form-actions">
                    <button onclick="saveScheduleConfig()" class="btn btn-primary" style="flex: 1;">Save Schedule</button>
                    <button type="button" onclick="closeScheduleModal()" class="btn btn-outline">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Recipe Modal -->
    <div id="createRecipeModal" class="modal hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Create Recipe</h2>
                <button class="modal-close" onclick="closeCreateRecipeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createRecipeForm" onsubmit="handleCreateRecipeSubmit(event)">
                    <div class="form-group">
                        <label for="recipeName">Recipe Name *</label>
                        <input type="text" id="recipeName" required placeholder="e.g., Chicken Stir Fry">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="recipeServings">Servings *</label>
                            <input type="number" id="recipeServings" required min="1" step="0.5" value="4">
                        </div>
                        <div class="form-group">
                            <label for="recipePrepTime">Prep Time (min)</label>
                            <input type="number" id="recipePrepTime" min="0" value="15">
                        </div>
                        <div class="form-group">
                            <label for="recipeCookTime">Cook Time (min)</label>
                            <input type="number" id="recipeCookTime" min="0" value="30">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="recipeIngredients">Ingredients *</label>
                        <div id="ingredientsList" style="display: grid; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <input type="text" class="ingredient-input" placeholder="e.g., 2 cups chicken breast, diced" required>
                        </div>
                        <button type="button" class="btn btn-outline btn-small" onclick="addIngredientField()">
                            + Add Ingredient
                        </button>
                        <p class="form-hint">Add one ingredient per line</p>
                    </div>

                    <div class="form-group">
                        <label for="recipeInstructions">Instructions *</label>
                        <div id="instructionsList" style="display: grid; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <textarea class="instruction-input" rows="2" placeholder="Step 1: Heat oil in a pan..." required></textarea>
                        </div>
                        <button type="button" class="btn btn-outline btn-small" onclick="addInstructionField()">
                            + Add Step
                        </button>
                        <p class="form-hint">Add one step per box</p>
                    </div>

                    <div class="form-group">
                        <label for="recipeTags">Tags (comma-separated)</label>
                        <input type="text" id="recipeTags" placeholder="e.g., dinner, asian, quick">
                        <p class="form-hint">Optional: Add tags to help organize and find this recipe</p>
                    </div>

                    <div class="form-group">
                        <label for="recipeSourceUrl">Source URL</label>
                        <input type="url" id="recipeSourceUrl" placeholder="https://example.com/recipe">
                        <p class="form-hint">Optional: Link to the original recipe</p>
                    </div>

                    <div class="form-group">
                        <label for="recipeImageUrl">Image URL</label>
                        <input type="url" id="recipeImageUrl" placeholder="https://example.com/image.jpg">
                        <p class="form-hint">Optional: Link to an image of the dish</p>
                    </div>

                    <div id="createRecipeStatus" class="status-message hidden"></div>

                    <div class="form-actions">
                        <button type="submit" id="createRecipeBtn" class="btn btn-primary" style="flex: 1;">Create Recipe</button>
                        <button type="button" class="btn btn-outline" onclick="closeCreateRecipeModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration from backend
        const DAYS_OF_WEEK = {{ config.DAYS_OF_WEEK | tojson }};
        const MEAL_SCHEDULE = {{ config.MEAL_SCHEDULE | tojson }};
        let currentPlanData = {% if current_plan %}{{ current_plan | tojson }}{% else %}null{% endif %};
        let currentShoppingList = {% if current_shopping_list %}{{ current_shopping_list.items | tojson }}{% else %}[]{% endif %};

        // CSRF-aware fetch: automatically adds X-CSRFToken header to all
        // state-changing requests (POST, PUT, PATCH, DELETE).
        function csrfFetch(url, options = {}) {
            const method = (options.method || 'GET').toUpperCase();
            if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {
                const token = document.querySelector('meta[name="csrf-token"]')?.content || '';
                options.headers = { 'X-CSRFToken': token, ...options.headers };
            }
            return fetch(url, options);
        }

        // Schedule management functions
        function getCustomSchedule() {
            const stored = localStorage.getItem('customSchedule');
            if (stored) {
                const schedule = JSON.parse(stored);
                // Normalize old plain-number format to object format
                Object.keys(schedule).forEach(day => {
                    Object.keys(schedule[day]).forEach(mealType => {
                        if (typeof schedule[day][mealType] === 'number') {
                            const isWeekday = !['Saturday', 'Sunday'].includes(day);
                            schedule[day][mealType] = {
                                servings: schedule[day][mealType],
                                can_cook: !(isWeekday && mealType === 'lunch'),
                            };
                        }
                    });
                });
                return schedule;
            }
            // Default: use config schedule with default servings
            const schedule = {};
            Object.keys(MEAL_SCHEDULE).forEach(day => {
                schedule[day] = {};
                const isWeekday = !['Saturday', 'Sunday'].includes(day);
                MEAL_SCHEDULE[day].forEach(mealType => {
                    schedule[day][mealType] = {
                        servings: {{ household_portions }},
                        can_cook: !(isWeekday && mealType === 'lunch'),
                    };
                });
            });
            return schedule;
        }

        function saveCustomSchedule(schedule) {
            localStorage.setItem('customSchedule', JSON.stringify(schedule));
            updateScheduleInfo();
        }

        function updateScheduleInfo() {
            const schedule = getCustomSchedule();
            const infoEl = document.getElementById('scheduleInfo');

            let totalMeals = 0;
            let scheduleText = [];

            Object.entries(schedule).forEach(([day, meals]) => {
                const mealCount = Object.keys(meals).length;
                if (mealCount > 0) {
                    totalMeals += mealCount;
                }
            });

            if (totalMeals > 0) {
                infoEl.innerHTML = `Configured for ${totalMeals} meals across the week`;
            } else {
                infoEl.innerHTML = 'Click "Configure Schedule" to set your meals';
            }
        }

        function openScheduleConfig() {
            const schedule = getCustomSchedule();
            const formEl = document.getElementById('scheduleConfigForm');

            formEl.innerHTML = DAYS_OF_WEEK.map(day => `
                <div class="card">
                    <h3 style="font-weight: 600; margin-bottom: 1rem; color: var(--color-text);">${day}</h3>
                    <div style="display: grid; gap: 0.75rem;">
                        ${['breakfast', 'lunch', 'dinner', 'snack'].map(mealType => {
                            const slotData = schedule[day]?.[mealType];
                            const servings = slotData ? slotData.servings : '';
                            const isWeekday = !['Saturday', 'Sunday'].includes(day);
                            const canCook = slotData ? slotData.can_cook : !(isWeekday && mealType === 'lunch');
                            const isEnabled = servings !== '';
                            return `
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <input
                                        type="checkbox"
                                        id="enable_${day}_${mealType}"
                                        ${isEnabled ? 'checked' : ''}
                                        onchange="toggleMealSlot('${day}', '${mealType}')"
                                        style="width: 20px; height: 20px; cursor: pointer;">
                                    <label for="enable_${day}_${mealType}" style="flex: 1; text-transform: capitalize; margin: 0; cursor: pointer;">${mealType}</label>
                                    <input
                                        type="number"
                                        id="servings_${day}_${mealType}"
                                        value="${servings}"
                                        min="0.5"
                                        step="0.5"
                                        placeholder="servings"
                                        ${!isEnabled ? 'disabled' : ''}
                                        style="width: 100px;">
                                    <button class="cook-mode-btn"
                                            id="cook_mode_${day}_${mealType}"
                                            data-can-cook="${canCook}"
                                            onclick="toggleCookMode(this)"
                                            ${!isEnabled ? 'disabled' : ''}
                                            title="${canCook ? 'Can cook (click to set Reheat only)' : 'Reheat only (click to set Can cook)'}">${canCook ? 'üç≥' : 'üî•'}</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');

            document.getElementById('scheduleModal').classList.remove('hidden');
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.add('hidden');
        }

        function toggleMealSlot(day, mealType) {
            const checkbox = document.getElementById(`enable_${day}_${mealType}`);
            const servingsInput = document.getElementById(`servings_${day}_${mealType}`);
            const cookModeBtn = document.getElementById(`cook_mode_${day}_${mealType}`);

            if (checkbox.checked) {
                servingsInput.disabled = false;
                if (!servingsInput.value) {
                    servingsInput.value = {{ household_portions }};
                }
                if (cookModeBtn) cookModeBtn.disabled = false;
            } else {
                servingsInput.disabled = true;
                servingsInput.value = '';
                if (cookModeBtn) cookModeBtn.disabled = true;
            }
        }

        function toggleCookMode(btn) {
            const newVal = btn.dataset.canCook !== 'true';
            btn.dataset.canCook = newVal;
            btn.textContent = newVal ? 'üç≥' : 'üî•';
            btn.title = newVal ? 'Can cook (click to set Reheat only)' : 'Reheat only (click to set Can cook)';
        }

        function saveScheduleConfig() {
            const schedule = {};

            DAYS_OF_WEEK.forEach(day => {
                schedule[day] = {};
                ['breakfast', 'lunch', 'dinner', 'snack'].forEach(mealType => {
                    const servingsInput = document.getElementById(`servings_${day}_${mealType}`);
                    if (servingsInput && servingsInput.value && !servingsInput.disabled) {
                        const cookModeBtn = document.getElementById(`cook_mode_${day}_${mealType}`);
                        schedule[day][mealType] = {
                            servings: parseFloat(servingsInput.value),
                            can_cook: cookModeBtn ? cookModeBtn.dataset.canCook === 'true' : true,
                        };
                    }
                });
            });

            saveCustomSchedule(schedule);
            closeScheduleModal();
            showMessage('Schedule saved! Click "Generate Plan" to create your meal plan.', 'success');
        }

        // Generate meal plan
        async function generatePlan() {
            const btn = document.getElementById('generateBtn');
            if (!btn) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Generating...';

            try {
                const schedule = getCustomSchedule();

                // Clear existing manual plan first
                await csrfFetch('/manual-plan/clear', { method: 'POST' });

                // Generate plan with custom schedule
                const response = await csrfFetch('/generate-with-schedule', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ schedule })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Meal plan generated! You can now edit individual meals.', 'success');
                    await loadCurrentPlan();
                    if (data.normalization_task_id) {
                        pollNormalization(data.normalization_task_id);
                    }
                } else if (data.error) {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error generating plan: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="btn-icon">üé≤</span> Generate Plan';
            }
        }

        // Clear week
        async function clearWeek() {
            if (!confirm('Clear all meals for this week?')) return;

            try {
                await csrfFetch('/manual-plan/clear', { method: 'POST' });
                showMessage('Week cleared', 'success');
                window.location.reload();
            } catch (error) {
                showMessage('Error clearing week: ' + error.message, 'error');
            }
        }

        // Load current plan
        async function loadCurrentPlan() {
            try {
                const response = await csrfFetch('/current-plan');
                const data = await response.json();

                if (data.plan) {
                    currentPlanData = data.plan;
                    renderWeeklyCalendar(data.plan);
                }

                if (data.shopping_list) {
                    currentShoppingList = data.shopping_list.items;
                    renderShoppingList();
                }
            } catch (error) {
                console.error('Error loading plan:', error);
            }
        }

        // Current day index for portrait mode navigation
        let currentDayIndex = 0;

        // Detect if we're in portrait/mobile mode
        function isPortraitMode() {
            return window.matchMedia('(max-width: 767px), (max-width: 1023px) and (orientation: portrait)').matches;
        }

        // Navigate between days in portrait mode
        function navigateDay(direction) {
            currentDayIndex = Math.max(0, Math.min(DAYS_OF_WEEK.length - 1, currentDayIndex + direction));
            updateDayView();
        }

        // Update the visible day and navigation controls
        function updateDayView() {
            if (!isPortraitMode()) return;

            const dayCards = document.querySelectorAll('.day-card');
            dayCards.forEach((card, index) => {
                card.classList.toggle('active', index === currentDayIndex);
            });

            const currentDay = DAYS_OF_WEEK[currentDayIndex];
            document.getElementById('currentDayName').textContent = currentDay;
            document.getElementById('prevDayBtn').disabled = currentDayIndex === 0;
            document.getElementById('nextDayBtn').disabled = currentDayIndex === DAYS_OF_WEEK.length - 1;

            const progressEl = document.getElementById('dayProgress');
            progressEl.innerHTML = DAYS_OF_WEEK.map((_, i) =>
                `<span class="progress-dot ${i === currentDayIndex ? 'active' : ''}"></span>`
            ).join('');
        }

        // Setup swipe gesture detection
        let touchStartX = 0;
        let touchEndX = 0;

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    navigateDay(1);
                } else {
                    navigateDay(-1);
                }
            }
        }

        const ALL_MEAL_TYPES = ['breakfast', 'lunch', 'snack', 'dinner'];

        // Placeholder SVG shown when recipe has no image
        const placeholderSvg = `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round" style="color:#a8a29e;opacity:0.6"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>`;

        function getHiddenMealTypes() {
            const stored = localStorage.getItem('hiddenMealTypes');
            return stored ? JSON.parse(stored) : [];
        }

        function saveHiddenMealTypes(hidden) {
            localStorage.setItem('hiddenMealTypes', JSON.stringify(hidden));
        }

        // Render weekly calendar
        function renderWeeklyCalendar(planData = null) {
            const calendarEl = document.getElementById('weeklyCalendar');
            const currentPlan = planData || currentPlanData;
            const hiddenMealTypes = getHiddenMealTypes();
            const visibleMealTypes = ALL_MEAL_TYPES.filter(m => !hiddenMealTypes.includes(m));

            calendarEl.innerHTML = DAYS_OF_WEEK.map((day, index) => {
                const dayNutrition = currentPlan?.daily_nutrition?.[day] || {};
                const dayCalories = Math.round(dayNutrition.calories || 0);
                const calorieLimit = currentPlan?.daily_calorie_limit;
                const isOverLimit = calorieLimit && dayCalories > calorieLimit;
                const limitText = calorieLimit ? ` / ${calorieLimit}` : '';

                // Detect hidden meal types that have recipes planned for this day
                const hiddenWithRecipes = hiddenMealTypes.filter(m =>
                    currentPlan?.meals?.some(meal => meal.day === day && meal.meal_type === m)
                );

                return `
                    <div class="day-card ${isPortraitMode() && index === currentDayIndex ? 'active' : ''}">
                        <div class="day-header ${isOverLimit ? 'over-limit' : ''}">
                            <div class="day-name">${day}</div>
                            <div class="day-calories">
                                <span class="calorie-badge">${dayCalories}${limitText} cal</span>
                                ${isOverLimit ? '‚ö†Ô∏è' : ''}
                            </div>
                        </div>
                        <div class="day-meals">
                            ${visibleMealTypes.map(mealType => renderMealSlot(day, mealType, currentPlan)).join('')}
                        </div>
                        ${hiddenWithRecipes.length > 0 ? `
                        <div class="meal-hidden-warning">
                            ‚ö†Ô∏è ${hiddenWithRecipes.length} hidden meal${hiddenWithRecipes.length > 1 ? 's' : ''} (${hiddenWithRecipes.join(', ')}) ‚Äî still in shopping list. <a href="#settings" onclick="scrollToSection('settings')" style="color:inherit;font-weight:600;">Show in Settings</a>
                        </div>` : ''}
                    </div>
                `;
            }).join('');

            updateResponsiveUI();
        }

        // Update UI based on orientation/screen size
        function updateResponsiveUI() {
            const navEl = document.getElementById('calendarNav');
            const hintEl = document.getElementById('swipeHint');
            const inPortrait = isPortraitMode();

            navEl.style.display = inPortrait ? 'flex' : 'none';

            if (inPortrait) {
                updateDayView();
                if (!localStorage.getItem('swipeHintShown')) {
                    hintEl.style.display = 'block';
                    setTimeout(() => {
                        localStorage.setItem('swipeHintShown', 'true');
                    }, 3000);
                } else {
                    hintEl.style.display = 'none';
                }
            } else {
                hintEl.style.display = 'none';
            }
        }

        function isNoCookSlot(day, mealType) {
            const slot = getCustomSchedule()[day]?.[mealType];
            return slot && slot.can_cook === false;
        }

        function renderMealSlot(day, mealType, currentPlan) {
            const meal = currentPlan?.meals?.find(m => m.day === day && m.meal_type === mealType);

            if (meal) {
                const isDerived = meal.meal_source === 'leftover' || meal.meal_source === 'packed_lunch';
                const derivedClass = isDerived ? ' meal-derived' : '';
                let badge = '';
                if (meal.meal_source === 'leftover') {
                    badge = '<span class="cook-once-badge reheat">Reheat</span>';
                } else if (meal.meal_source === 'packed_lunch') {
                    badge = '<span class="cook-once-badge pack">Pack</span>';
                } else if (meal.meal_source === 'fresh' && isNoCookSlot(day, mealType)) {
                    badge = '<span class="cook-once-badge no-cook">üî•</span>';
                }

                // Cook-ahead indicator: count how many derived meals reference this slot
                const sourceKey = `${day}:${mealType}`;
                const derivedFromThis = currentPlan?.meals?.filter(m => m.linked_meal === sourceKey) || [];
                const cookAheadBadge = (!isDerived && derivedFromThis.length > 0)
                    ? `<span class="cook-once-badge cook-ahead" title="Also used for: ${derivedFromThis.map(m => m.day + ' ' + m.meal_type).join(', ')}">Makes ${derivedFromThis.length + 1} meals</span>`
                    : '';
                const swapBtn = isDerived ? '' : `
                                <button class="btn-icon" onclick="event.stopPropagation(); regenerateMeal('${day}', '${mealType}')" title="Swap recipe">
                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><polyline points="23 20 23 14 17 14"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                                </button>`;
                const imageAreaHtml = meal.image_url
                    ? `<div class="meal-image-area"><img class="meal-image" src="${meal.image_url}" alt="" loading="lazy" onerror="this.parentElement.innerHTML=placeholderSvg"></div>`
                    : `<div class="meal-image-area"><div class="meal-placeholder">${placeholderSvg}</div></div>`;
                return `
                    <div class="meal-slot has-meal${derivedClass}" style="cursor:pointer;" onclick="window.location='/recipe/${meal.recipe_id}'">
                        <div class="meal-slot-header">
                            <span class="meal-type">${mealType}${badge}${cookAheadBadge}</span>
                            <div class="meal-actions">
                                <button class="btn-icon" onclick="event.stopPropagation(); editMealServings('${day}', '${mealType}', ${meal.portions || 1})" title="Edit servings">
                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                </button>
                                ${swapBtn}
                                <button class="btn-icon btn-danger" onclick="event.stopPropagation(); removeMeal('${day}', '${mealType}')" title="Remove">
                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                </button>
                            </div>
                        </div>
                        ${imageAreaHtml}
                        <div class="meal-slot-footer">
                            <div class="meal-name" title="${(meal.recipe_name || 'Unnamed Recipe').replace(/"/g, '&quot;')}">
                                <a href="/recipe/${meal.recipe_id}" onclick="event.stopPropagation()">${meal.recipe_name || 'Unnamed Recipe'}</a>
                            </div>
                            <div class="meal-nutrition">
                                <span>üî• ${meal.calories ? Math.round(meal.calories) : 0}</span>
                                <span>üçó ${meal.protein ? Math.round(meal.protein) : 0}g</span>
                                <span>üçΩÔ∏è √ó${meal.portions || 1}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="meal-slot" onclick="openRecipeSelector('${day}', '${mealType}')">
                        <div class="meal-slot-header">
                            <span class="meal-type">${mealType}</span>
                        </div>
                        <div class="empty-slot">
                            <button class="empty-slot-plus-btn" onclick="event.stopPropagation(); openRecipeSelector('${day}', '${mealType}')" aria-label="Add ${mealType}">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <line x1="12" y1="3" x2="12" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <line x1="3" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Meal management functions
        async function addMeal(day, mealType, recipeId, servings) {
            try {
                const response = await csrfFetch('/manual-plan/add-meal', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ day, meal_type: mealType, recipe_id: recipeId, servings })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Meal added!', 'success');
                    await loadCurrentPlan();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to add meal'), 'error');
                }
            } catch (error) {
                showMessage('Error adding meal: ' + error.message, 'error');
            }
        }

        async function removeMeal(day, mealType) {
            if (!confirm('Remove this meal?')) return;

            try {
                const response = await csrfFetch('/manual-plan/remove-meal', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ day, meal_type: mealType })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Meal removed', 'success');
                    await loadCurrentPlan();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to remove meal'), 'error');
                }
            } catch (error) {
                showMessage('Error removing meal: ' + error.message, 'error');
            }
        }

        async function editMealServings(day, mealType, currentServings) {
            const newServings = prompt(`Enter new servings for ${mealType}:`, currentServings);
            if (!newServings || isNaN(newServings)) return;

            try {
                const response = await csrfFetch('/manual-plan/update-servings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ day, meal_type: mealType, servings: parseFloat(newServings) })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Servings updated', 'success');
                    await loadCurrentPlan();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to update servings'), 'error');
                }
            } catch (error) {
                showMessage('Error updating servings: ' + error.message, 'error');
            }
        }

        async function regenerateMeal(day, mealType) {
            if (!confirm(`Regenerate ${mealType} with a different recipe?`)) return;

            try {
                const response = await csrfFetch('/manual-plan/regenerate-meal', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ day, meal_type: mealType })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(`Regenerated with: ${data.recipe_name}`, 'success');
                    await loadCurrentPlan();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to regenerate meal'), 'error');
                }
            } catch (error) {
                showMessage('Error regenerating meal: ' + error.message, 'error');
            }
        }

        async function openRecipeSelector(day, mealType) {
            // Fetch all recipes from API (up to 1000)
            try {
                const response = await csrfFetch('/api/recipes?per_page=1000');
                const data = await response.json();
                const recipes = data.recipes;

                if (recipes.length === 0) {
                    alert('No recipes available. Import a recipe first!');
                    return;
                }

                const recipeId = prompt(`Enter recipe ID or name for ${day} ${mealType}:\n\n` +
                    recipes.map(r => `- ${r.id}: ${r.name}`).join('\n'));

                if (!recipeId) return;

                const recipe = recipes.find(r => r.id === recipeId || r.name.toLowerCase().includes(recipeId.toLowerCase()));
                if (!recipe) {
                    alert('Recipe not found');
                    return;
                }

                const servings = prompt('How many servings?', {{ household_portions }});
                if (!servings || isNaN(servings)) return;

                await addMeal(day, mealType, recipe.id, parseFloat(servings));
            } catch (error) {
                console.error('Error fetching recipes:', error);
                alert('Error loading recipes. Please try again.');
            }
        }

        // Shopping list functions
        function toggleShoppingItem(checkbox) {
            const item = checkbox.closest('.shopping-item');
            if (checkbox.checked) {
                item.classList.add('checked');
            } else {
                item.classList.remove('checked');
            }
            saveShoppingListState();
        }

        function saveShoppingListState() {
            const checkboxes = document.querySelectorAll('.shopping-item input[type="checkbox"]');
            const state = Array.from(checkboxes).map(cb => cb.checked);
            localStorage.setItem('shoppingListState', JSON.stringify(state));
        }

        function loadShoppingListState() {
            const stateStr = localStorage.getItem('shoppingListState');
            if (!stateStr) return;

            try {
                const state = JSON.parse(stateStr);
                const checkboxes = document.querySelectorAll('.shopping-item input[type="checkbox"]');
                checkboxes.forEach((cb, i) => {
                    if (state[i]) {
                        cb.checked = true;
                        cb.closest('.shopping-item').classList.add('checked');
                    }
                });
            } catch (e) {
                console.error('Error loading shopping list state:', e);
            }
        }

        function uncheckAllShoppingItems() {
            const checkboxes = document.querySelectorAll('.shopping-item input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.closest('.shopping-item').classList.remove('checked');
            });
            saveShoppingListState();
        }

        const _NORM_MESSAGES = [
            "üç≥ Teaching our AI to grocery shop‚Ä¶",
            "ü•ï Merging your duplicates with love‚Ä¶",
            "ü§ñ Consulting the robot chef‚Ä¶",
            "üõí Making sure you don't need 0.46 T of ketchup‚Ä¶",
            "ü•¶ Sorting vegetables by vibe‚Ä¶",
            "üçñ Negotiating with your chicken breasts‚Ä¶",
            "ü•ö Settling the egg vs large egg debate‚Ä¶",
            "üßÑ Squishing duplicate garlic‚Ä¶",
            "üî¨ Analysing if 0.46 tablespoons is a real thing‚Ä¶",
            "ü§ù Getting burger buns and hamburger buns to agree‚Ä¶",
            "üß† Asking GPT if salt counts as an ingredient‚Ä¶",
            "üõçÔ∏è Building the perfect list, one item at a time‚Ä¶",
        ];
        let _normMsgIdx = 0;
        let _normMsgTimer = null;

        function _showShoppingLoadingState() {
            const container = document.getElementById('shoppingListContainer');
            const actionsEl  = document.getElementById('shoppingListActions');
            const subtitleEl = document.getElementById('shoppingListSubtitle');
            if (!container) return;
            _normMsgIdx = Math.floor(Math.random() * _NORM_MESSAGES.length);
            container.style.display = 'block';
            container.innerHTML = `
                <div class="shopping-loading">
                    <div class="shopping-loading-msg" id="shoppingLoadingMsg">${_NORM_MESSAGES[_normMsgIdx]}</div>
                    <div class="skeleton-shopping">
                        ${[82, 65, 74, 58, 70].map(w =>
                            `<div class="skeleton-item" style="width:${w}%"></div>`
                        ).join('')}
                    </div>
                </div>`;
            if (actionsEl) actionsEl.style.display = 'none';
            if (subtitleEl) subtitleEl.textContent = 'Organising your shopping list‚Ä¶';
            // Rotate the message every 2.5 s
            if (_normMsgTimer) clearInterval(_normMsgTimer);
            _normMsgTimer = setInterval(() => {
                const el = document.getElementById('shoppingLoadingMsg');
                if (!el) { clearInterval(_normMsgTimer); return; }
                _normMsgIdx = (_normMsgIdx + 1) % _NORM_MESSAGES.length;
                el.style.opacity = '0';
                setTimeout(() => {
                    el.textContent = _NORM_MESSAGES[_normMsgIdx];
                    el.style.opacity = '1';
                }, 150);
            }, 2500);
        }

        // Poll a normalization task; show skeleton loader while waiting
        function pollNormalization(taskId) {
            _showShoppingLoadingState();

            const poll = async () => {
                try {
                    const res = await csrfFetch(`/shopping-list/normalize/${taskId}`);
                    if (!res.ok) { _stopLoadingAndRender(); return; }
                    const data = await res.json();
                    if (data.status === 'done' && data.items) {
                        if (_normMsgTimer) { clearInterval(_normMsgTimer); _normMsgTimer = null; }
                        currentShoppingList = data.items;
                        renderShoppingList();
                    } else if (data.status === 'pending') {
                        setTimeout(poll, 2000);
                    } else {
                        _stopLoadingAndRender(); // failed / not_found ‚Äî show raw list
                    }
                } catch (e) {
                    _stopLoadingAndRender();
                }
            };
            setTimeout(poll, 2000);
        }

        function _stopLoadingAndRender() {
            if (_normMsgTimer) { clearInterval(_normMsgTimer); _normMsgTimer = null; }
            renderShoppingList();
        }

        // Render shopping list with edit functionality
        function renderShoppingList() {
            const container = document.getElementById('shoppingListContainer');
            if (!container) return;

            const actionsEl = document.getElementById('shoppingListActions');
            const subtitleEl = document.getElementById('shoppingListSubtitle');
            const countEl = document.getElementById('shoppingListCount');

            if (!currentShoppingList || currentShoppingList.length === 0) {
                container.innerHTML = '';
                container.style.display = 'none';
                if (actionsEl) actionsEl.style.display = 'none';
                if (subtitleEl && !countEl) subtitleEl.textContent = 'Generate a meal plan to create a shopping list';
                return;
            }

            container.style.display = 'block';
            if (actionsEl) actionsEl.style.display = 'flex';

            const itemsByCategory = {};
            currentShoppingList.forEach(item => {
                const cat = item.category || 'other';
                if (!itemsByCategory[cat]) itemsByCategory[cat] = [];
                itemsByCategory[cat].push(item);
            });

            const totalItems = currentShoppingList.length;
            const totalCategories = Object.keys(itemsByCategory).length;
            const summaryText = `${totalItems} ingredient${totalItems !== 1 ? 's' : ''} across ${totalCategories} categor${totalCategories !== 1 ? 'ies' : 'y'}`;
            if (subtitleEl) subtitleEl.textContent = summaryText;

            const categoryIcons = {
                'produce': 'ü•¶',
                'meat': 'ü•©',
                'seafood': 'üêü',
                'dairy': 'üßÄ',
                'grains': 'üåæ',
                'spices': 'üå∂Ô∏è',
                'pantry': 'ü´ô',
                'other': 'üõí',
            };
            const categoryLabels = {
                'produce': 'Produce',
                'meat': 'Meat',
                'seafood': 'Seafood',
                'dairy': 'Dairy & Eggs',
                'grains': 'Grains & Bread',
                'spices': 'Spices & Herbs',
                'pantry': 'Pantry',
                'other': 'Other',
            };

            container.innerHTML = Object.entries(itemsByCategory).map(([category, items]) => `
                <div class="shopping-category">
                    <div class="category-header">
                        <span class="category-icon">${categoryIcons[category] || 'üõí'}</span>
                        <h3 class="category-name">${categoryLabels[category] || (category.charAt(0).toUpperCase() + category.slice(1))}</h3>
                    </div>
                    <div class="shopping-items">
                        ${items.map((item, idx) => {
                            const globalIndex = currentShoppingList.indexOf(item);
                            return `
                                <div class="shopping-item" data-index="${globalIndex}">
                                    <input type="checkbox" onchange="toggleShoppingItem(this)">
                                    <div class="item-body">
                                        <span class="item-text" onclick="editShoppingItem(${globalIndex})">
                                            ${item.quantity != null ? formatQty(item.quantity) + (item.unit ? ' ' + item.unit : '') + ' ' : ''}${item.item}
                                        </span>
                                        ${item.sources && item.sources.length ? `<span class="item-sources">${item.sources.slice(0, 3).join(' ¬∑ ')
                                            }${item.sources.length > 3 ? ` ¬∑ +${item.sources.length - 3} more` : ''}</span>` : ''}
                                    </div>
                                    <div class="item-actions">
                                        <button class="item-action-btn" onclick="editShoppingItem(${globalIndex})" title="Edit">‚úèÔ∏è</button>
                                        <button class="item-action-btn" onclick="deleteShoppingItem(${globalIndex})" title="Delete">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');

            setTimeout(loadShoppingListState, 0);
        }

        // Edit shopping list item
        async function editShoppingItem(index) {
            const item = currentShoppingList[index];
            const itemEl = document.querySelector(`.shopping-item[data-index="${index}"]`);
            const textSpan = itemEl.querySelector('.item-text');

            const editMode = `
                <div class="item-edit-mode">
                    <input type="number" class="item-edit-input item-quantity-input"
                           value="${item.quantity}" step="0.1" min="0.1" id="edit-qty-${index}">
                    <input type="text" class="item-edit-input"
                           value="${item.unit}" placeholder="unit" id="edit-unit-${index}" style="width: 60px;">
                    <input type="text" class="item-edit-input item-name-input"
                           value="${item.item}" id="edit-name-${index}">
                    <button class="btn btn-small btn-primary" onclick="saveShoppingItem(${index})">‚úì</button>
                    <button class="btn btn-small btn-outline" onclick="renderShoppingList()">‚úï</button>
                </div>
            `;

            textSpan.parentElement.innerHTML = editMode;
            document.getElementById(`edit-name-${index}`).focus();
        }

        // Save edited shopping list item
        async function saveShoppingItem(index) {
            const quantity = parseFloat(document.getElementById(`edit-qty-${index}`).value);
            const name = document.getElementById(`edit-name-${index}`).value.trim();

            if (!name || quantity <= 0) {
                showMessage('Invalid item name or quantity', 'error');
                return;
            }

            try {
                const response = await csrfFetch('/shopping-list/update-item', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ index, quantity, name })
                });

                const data = await response.json();

                if (data.success) {
                    currentShoppingList[index].quantity = data.item.quantity;
                    currentShoppingList[index].item = data.item.item;
                    showMessage('Item updated', 'success');
                    renderShoppingList();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to update item'), 'error');
                }
            } catch (error) {
                showMessage('Error updating item: ' + error.message, 'error');
            }
        }

        // Delete shopping list item
        async function deleteShoppingItem(index) {
            if (!confirm('Delete this item?')) return;

            try {
                const response = await csrfFetch('/shopping-list/delete-item', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ index })
                });

                const data = await response.json();

                if (data.success) {
                    currentShoppingList.splice(index, 1);
                    showMessage('Item deleted', 'success');
                    renderShoppingList();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to delete item'), 'error');
                }
            } catch (error) {
                showMessage('Error deleting item: ' + error.message, 'error');
            }
        }

        // Add custom shopping list item
        function openAddItemModal() {
            document.getElementById('addItemForm').reset();
            document.getElementById('addItemName').focus();
            document.getElementById('addItemModal').classList.remove('hidden');
        }

        function closeAddItemModal() {
            document.getElementById('addItemModal').classList.add('hidden');
        }

        async function submitAddItemForm(event) {
            event.preventDefault();
            const name = document.getElementById('addItemName').value.trim();
            const quantity = parseFloat(document.getElementById('addItemQuantity').value) || 1;
            const unit = document.getElementById('addItemUnit').value.trim();
            const category = document.getElementById('addItemCategory').value;
            closeAddItemModal();
            await addShoppingItem(name, quantity, unit, category);
        }

        async function addShoppingItem(name, quantity, unit, category) {
            try {
                const response = await csrfFetch('/shopping-list/add-item', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, quantity, unit, category })
                });

                const data = await response.json();

                if (data.success) {
                    currentShoppingList.push(data.item);
                    currentShoppingList.sort((a, b) => {
                        if (a.category !== b.category) return a.category.localeCompare(b.category);
                        return a.item.localeCompare(b.item);
                    });
                    showMessage('Item added', 'success');
                    renderShoppingList();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to add item'), 'error');
                }
            } catch (error) {
                showMessage('Error adding item: ' + error.message, 'error');
            }
        }

        // Import modal functions
        function openImportModal(tab) {
            document.getElementById('importModal').classList.remove('hidden');
            switchImportTab(tab || 'url');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('importRecipeForm').reset();
            document.getElementById('importTextForm').reset();
            document.getElementById('importPhotoForm').reset();
            document.getElementById('importStatus').classList.add('hidden');
            document.getElementById('importTextStatus').classList.add('hidden');
            document.getElementById('importPhotoStatus').classList.add('hidden');
            document.getElementById('photoPreview').style.display = 'none';
        }

        function switchImportTab(tab) {
            // Update tab buttons
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                if (t.textContent.includes('URL') && tab === 'url') {
                    t.classList.add('active');
                } else if (t.textContent.includes('Text') && tab === 'text') {
                    t.classList.add('active');
                } else if (t.textContent.includes('Photo') && tab === 'photo') {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });

            // Update forms
            const urlForm = document.getElementById('importRecipeForm');
            const textForm = document.getElementById('importTextForm');
            const photoForm = document.getElementById('importPhotoForm');

            urlForm.classList.add('hidden');
            textForm.classList.add('hidden');
            photoForm.classList.add('hidden');

            if (tab === 'url') {
                urlForm.classList.remove('hidden');
            } else if (tab === 'text') {
                textForm.classList.remove('hidden');
            } else if (tab === 'photo') {
                photoForm.classList.remove('hidden');
            }
        }

        // Handle share target query parameters from PWA share
        function handleShareTargetParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const importUrl = urlParams.get('import_url');
            const importText = urlParams.get('import_text');

            if (importUrl) {
                // Auto-open import modal with URL pre-filled
                openImportModal();
                switchImportTab('url');
                document.getElementById('recipeUrl').value = decodeURIComponent(importUrl);
                showMessage('Recipe URL shared to Meal Planner! Click "Import Recipe" to continue.', 'success');

                // Clean up URL without page reload
                window.history.replaceState({}, document.title, '/');
            } else if (importText) {
                // Auto-open import modal with text pre-filled
                openImportModal();
                switchImportTab('text');
                document.getElementById('recipeText').value = decodeURIComponent(importText);
                showMessage('Recipe text shared to Meal Planner! Click "Import from Text" to continue.', 'success');

                // Clean up URL without page reload
                window.history.replaceState({}, document.title, '/');
            }
        }

        // Photo preview
        document.addEventListener('DOMContentLoaded', () => {
            const photoInput = document.getElementById('recipePhoto');
            if (photoInput) {
                photoInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const preview = document.getElementById('photoPreview');
                            const img = document.getElementById('photoPreviewImg');
                            img.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Initialize
            updateScheduleInfo();
            renderWeeklyCalendar();
            renderShoppingList();
            loadShoppingListState();

            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            }

            // Handle share target query parameters
            handleShareTargetParams();

            // Setup touch gestures for swipe navigation
            const calendarEl = document.getElementById('weeklyCalendar');
            calendarEl.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            calendarEl.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });

            // Handle keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (!isPortraitMode()) return;
                if (e.key === 'ArrowLeft') {
                    navigateDay(-1);
                } else if (e.key === 'ArrowRight') {
                    navigateDay(1);
                }
            });

            // Update responsive UI on resize/orientation change
            window.addEventListener('resize', updateResponsiveUI);
            window.addEventListener('orientationchange', () => {
                setTimeout(updateResponsiveUI, 100);
            });
        });

        // Import form handlers
        async function handleImportFormSubmit(event) {
            event.preventDefault();
            const url = document.getElementById('recipeUrl').value;
            const importBtn = document.getElementById('importBtn');
            const statusEl = document.getElementById('importStatus');

            importBtn.disabled = true;
            importBtn.innerHTML = '<span class="loading"></span> Importing...';
            statusEl.className = 'status-message';
            statusEl.textContent = 'Importing recipe...';
            statusEl.classList.remove('hidden');

            try {
                const response = await csrfFetch('/import-recipe', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusEl.className = 'status-message success';
                    statusEl.textContent = data.message;
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    statusEl.className = 'status-message error';
                    statusEl.textContent = data.message || data.error || 'Error importing recipe';
                }
            } catch (error) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'Error: ' + error.message;
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = 'Import Recipe';
            }
        }

        async function handleTextImportFormSubmit(event) {
            event.preventDefault();
            const text = document.getElementById('recipeText').value;
            const importBtn = document.getElementById('importTextBtn');
            const statusEl = document.getElementById('importTextStatus');

            importBtn.disabled = true;
            importBtn.innerHTML = '<span class="loading"></span> Extracting...';
            statusEl.className = 'status-message';
            statusEl.textContent = 'Using AI to extract recipe...';
            statusEl.classList.remove('hidden');

            try {
                const response = await csrfFetch('/import-recipe-text', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text, language: 'auto' })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusEl.className = 'status-message success';
                    statusEl.textContent = data.message;
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    statusEl.className = 'status-message error';
                    statusEl.textContent = data.message || data.error || 'Error importing recipe';
                }
            } catch (error) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'Error: ' + error.message;
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = 'Import from Text';
            }
        }

        async function handlePhotoImportFormSubmit(event) {
            event.preventDefault();
            const fileInput = document.getElementById('recipePhoto');
            const file = fileInput.files[0];
            const importBtn = document.getElementById('importPhotoBtn');
            const statusEl = document.getElementById('importPhotoStatus');

            if (!file) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'Please select an image file';
                statusEl.classList.remove('hidden');
                return;
            }

            // Log file details for debugging
            console.log('[IMAGE UPLOAD] File selected:', {
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: new Date(file.lastModified).toISOString()
            });

            // Check file size (warn if > 10MB)
            if (file.size > 10 * 1024 * 1024) {
                console.warn('[IMAGE UPLOAD] Large file detected:', (file.size / (1024 * 1024)).toFixed(2), 'MB');
            }

            importBtn.disabled = true;
            importBtn.innerHTML = '<span class="loading"></span> Analyzing...';
            statusEl.className = 'status-message';
            statusEl.textContent = 'Using AI to extract recipe from photo... (10-15 seconds)';
            statusEl.classList.remove('hidden');

            try {
                const formData = new FormData();
                formData.append('image', file);
                console.log('[IMAGE UPLOAD] FormData created, starting upload...');

                const response = await csrfFetch('/import-recipe-image', {
                    method: 'POST',
                    body: formData
                });

                console.log('[IMAGE UPLOAD] Response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                const data = await response.json();
                console.log('[IMAGE UPLOAD] Response data:', data);

                if (response.ok && data.success) {
                    statusEl.className = 'status-message success';
                    statusEl.textContent = data.message;
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    statusEl.className = 'status-message error';
                    const errorMsg = data.message || data.error || 'Error importing recipe';
                    statusEl.textContent = errorMsg;
                    console.error('[IMAGE UPLOAD] Error response:', {
                        status: response.status,
                        error: data.error,
                        message: data.message,
                        suggestion: data.suggestion
                    });
                }
            } catch (error) {
                statusEl.className = 'status-message error';
                const errorMsg = 'Error: ' + error.message;
                statusEl.textContent = errorMsg;
                console.error('[IMAGE UPLOAD] Exception caught:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = 'Import from Photo';
            }
        }

        // Show message function
        function showMessage(message, type = 'success') {
            // Create temporary message
            const messageEl = document.createElement('div');
            messageEl.className = `status-message ${type}`;
            messageEl.textContent = message;
            messageEl.style.position = 'fixed';
            messageEl.style.top = '2rem';
            messageEl.style.right = '2rem';
            messageEl.style.zIndex = '9999';
            messageEl.style.minWidth = '300px';
            messageEl.style.animation = 'slideInRight 0.3s ease';

            document.body.appendChild(messageEl);

            setTimeout(() => {
                messageEl.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => messageEl.remove(), 300);
            }, 3000);
        }

        // Create Recipe modal functions
        function openCreateRecipeModal() {
            document.getElementById('createRecipeModal').classList.remove('hidden');
            // Reset form to initial state with 1 ingredient and 1 instruction
            document.getElementById('createRecipeForm').reset();
            document.getElementById('ingredientsList').innerHTML = '<input type="text" class="ingredient-input" placeholder="e.g., 2 cups chicken breast, diced" required>';
            document.getElementById('instructionsList').innerHTML = '<textarea class="instruction-input" rows="2" placeholder="Step 1: Heat oil in a pan..." required></textarea>';
            document.getElementById('createRecipeStatus').classList.add('hidden');
        }

        function closeCreateRecipeModal() {
            document.getElementById('createRecipeModal').classList.add('hidden');
        }

        function addIngredientField() {
            const list = document.getElementById('ingredientsList');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'ingredient-input';
            input.placeholder = 'e.g., 1 cup water';
            list.appendChild(input);
        }

        function addInstructionField() {
            const list = document.getElementById('instructionsList');
            const textarea = document.createElement('textarea');
            textarea.className = 'instruction-input';
            textarea.rows = 2;
            textarea.placeholder = `Step ${list.children.length + 1}: ...`;
            list.appendChild(textarea);
        }

        async function handleCreateRecipeSubmit(event) {
            event.preventDefault();

            const createBtn = document.getElementById('createRecipeBtn');
            const statusEl = document.getElementById('createRecipeStatus');

            // Gather form data
            const name = document.getElementById('recipeName').value.trim();
            const servings = parseFloat(document.getElementById('recipeServings').value);
            const prepTime = parseInt(document.getElementById('recipePrepTime').value) || 0;
            const cookTime = parseInt(document.getElementById('recipeCookTime').value) || 0;
            const tagsStr = document.getElementById('recipeTags').value.trim();
            const sourceUrl = document.getElementById('recipeSourceUrl').value.trim();
            const imageUrl = document.getElementById('recipeImageUrl').value.trim();

            // Gather ingredients (filter out empty ones)
            const ingredientInputs = document.querySelectorAll('.ingredient-input');
            const ingredients = Array.from(ingredientInputs)
                .map(input => input.value.trim())
                .filter(val => val.length > 0);

            // Gather instructions (filter out empty ones)
            const instructionInputs = document.querySelectorAll('.instruction-input');
            const instructions = Array.from(instructionInputs)
                .map(textarea => textarea.value.trim())
                .filter(val => val.length > 0);

            // Validate
            if (ingredients.length === 0) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'At least one ingredient is required';
                statusEl.classList.remove('hidden');
                return;
            }

            if (instructions.length === 0) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'At least one instruction step is required';
                statusEl.classList.remove('hidden');
                return;
            }

            // Parse tags
            const tags = tagsStr.length > 0
                ? tagsStr.split(',').map(t => t.trim()).filter(t => t.length > 0)
                : ['manual-entry'];

            // Build request body
            const recipeData = {
                name,
                servings,
                prep_time_minutes: prepTime,
                cook_time_minutes: cookTime,
                ingredients,
                instructions,
                tags,
                source_url: sourceUrl || null,
                image_url: imageUrl || null
            };

            // Submit
            createBtn.disabled = true;
            createBtn.innerHTML = '<span class="loading"></span> Creating...';
            statusEl.className = 'status-message';
            statusEl.textContent = 'Creating recipe...';
            statusEl.classList.remove('hidden');

            try {
                const response = await csrfFetch('/recipes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(recipeData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusEl.className = 'status-message success';
                    statusEl.textContent = data.message;
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    statusEl.className = 'status-message error';
                    statusEl.textContent = data.message || data.error || 'Error creating recipe';
                }
            } catch (error) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'Error: ' + error.message;
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = 'Create Recipe';
            }
        }

        // Format a quantity to max 2 decimal places, removing trailing zeros
        function formatQty(n) {
            if (!n && n !== 0) return '';
            const rounded = Math.round(n * 100) / 100;
            return rounded % 1 === 0 ? rounded.toString() : rounded.toFixed(2).replace(/\.?0+$/, '');
        }

        // ============================================
        // Recipe Library - API-based Filtering
        // ============================================

        let currentPage = 1;
        let currentFilters = {
            search: '',
            tags: [],
            sort: ''
        };

        // Fetch and render recipes from API
        async function fetchRecipes(page = 1) {
            const params = new URLSearchParams({
                page: page,
                per_page: 24
            });

            if (currentFilters.search) {
                params.append('search', currentFilters.search);
            }

            if (currentFilters.tags.length > 0) {
                params.append('tags', currentFilters.tags.join(','));
            }

            if (currentFilters.sort) {
                params.append('sort', currentFilters.sort);
            }

            // Show loading state
            document.getElementById('recipeLoading').style.display = 'block';
            document.getElementById('recipeGrid').style.display = 'none';
            document.getElementById('recipeEmpty').style.display = 'none';
            document.getElementById('recipePagination').style.display = 'none';

            try {
                const response = await csrfFetch(`/api/recipes?${params}`);
                const data = await response.json();

                currentPage = page;

                // Update recipe count
                const countEl = document.getElementById('recipeCount');
                countEl.textContent = `${data.pagination.total_recipes} recipe${data.pagination.total_recipes !== 1 ? 's' : ''} found`;

                // Hide loading
                document.getElementById('recipeLoading').style.display = 'none';

                if (data.recipes.length === 0) {
                    // Show empty state
                    document.getElementById('recipeEmpty').style.display = 'block';
                } else {
                    // Render recipes
                    renderRecipes(data.recipes);
                    renderPagination(data.pagination);
                    document.getElementById('recipeGrid').style.display = 'grid';
                    document.getElementById('recipePagination').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error fetching recipes:', error);
                document.getElementById('recipeLoading').style.display = 'none';
                document.getElementById('recipeEmpty').style.display = 'block';
            }
        }

        // Render recipe cards
        function renderRecipes(recipes) {
            const grid = document.getElementById('recipeGrid');

            grid.innerHTML = recipes.map(recipe => {
                // Determine emoji
                let emoji = 'üç≤';
                if (recipe.tags.includes('italian')) emoji = 'üçù';
                else if (recipe.tags.includes('mexican')) emoji = 'üåÆ';
                else if (recipe.tags.includes('asian')) emoji = 'üçú';
                else if (recipe.tags.includes('breakfast')) emoji = 'ü•û';
                else if (recipe.tags.includes('dessert')) emoji = 'üç∞';
                else if (recipe.tags.includes('salad')) emoji = 'ü•ó';

                const imageHtml = recipe.image_url
                    ? `<img src="${recipe.image_url}" alt="${recipe.name}" loading="lazy">`
                    : `<span class="recipe-image-emoji">${emoji}</span>`;

                const timeHtml = recipe.total_time_minutes
                    ? `<span>‚è±Ô∏è ${recipe.total_time_minutes} min</span>`
                    : '';

                const caloriesHtml = recipe.nutrition_per_serving?.calories
                    ? `<span>üî• ${Math.round(recipe.nutrition_per_serving.calories)} cal</span>`
                    : '';

                const tagsHtml = recipe.tags.slice(0, 3).map(tag =>
                    `<span class="tag">${tag}</span>`
                ).join('');

                return `
                    <div class="recipe-card" onclick="window.location.href='/recipe/${recipe.id}'">
                        <div class="recipe-image">
                            ${imageHtml}
                        </div>
                        <div class="recipe-content">
                            <h3 class="recipe-title">${recipe.name}</h3>
                            <div class="recipe-meta">
                                <span>üçΩÔ∏è ${recipe.servings} servings</span>
                                ${timeHtml}
                                ${caloriesHtml}
                            </div>
                            ${tagsHtml ? `<div class="recipe-tags">${tagsHtml}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render pagination controls
        function renderPagination(pagination) {
            const container = document.getElementById('recipePagination');

            if (pagination.total_pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            if (pagination.has_prev) {
                html += `<button class="btn btn-outline btn-small" onclick="fetchRecipes(${pagination.page - 1})">‚Üê Previous</button>`;
            }

            // Page numbers (show max 7 pages)
            const maxVisible = 7;
            let startPage = Math.max(1, pagination.page - Math.floor(maxVisible / 2));
            let endPage = Math.min(pagination.total_pages, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            if (startPage > 1) {
                html += `<button class="btn btn-outline btn-small" onclick="fetchRecipes(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span style="padding: 0 0.5rem; color: var(--color-text-muted);">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                if (i === pagination.page) {
                    html += `<button class="btn btn-primary btn-small">${i}</button>`;
                } else {
                    html += `<button class="btn btn-outline btn-small" onclick="fetchRecipes(${i})">${i}</button>`;
                }
            }

            if (endPage < pagination.total_pages) {
                if (endPage < pagination.total_pages - 1) {
                    html += `<span style="padding: 0 0.5rem; color: var(--color-text-muted);">...</span>`;
                }
                html += `<button class="btn btn-outline btn-small" onclick="fetchRecipes(${pagination.total_pages})">${pagination.total_pages}</button>`;
            }

            // Next button
            if (pagination.has_next) {
                html += `<button class="btn btn-outline btn-small" onclick="fetchRecipes(${pagination.page + 1})">Next ‚Üí</button>`;
            }

            container.innerHTML = html;
        }

        // Apply filters and fetch
        function applyFilters() {
            currentFilters.search = document.getElementById('recipeSearch').value.trim();
            currentFilters.sort = document.getElementById('recipeSort').value;

            // Show/hide clear button
            const clearBtn = document.getElementById('clearSearch');
            clearBtn.style.display = currentFilters.search ? 'block' : 'none';

            fetchRecipes(1);
        }

        // Clear search
        function clearSearch() {
            document.getElementById('recipeSearch').value = '';
            applyFilters();
        }

        // Toggle tag filter
        function toggleTagFilter(button) {
            const tag = button.dataset.tag;
            button.classList.toggle('active');

            if (button.classList.contains('active')) {
                if (!currentFilters.tags.includes(tag)) {
                    currentFilters.tags.push(tag);
                }
            } else {
                currentFilters.tags = currentFilters.tags.filter(t => t !== tag);
            }

            fetchRecipes(1);
        }

        // Clear all tag filters
        function clearAllTags() {
            currentFilters.tags = [];
            document.querySelectorAll('.tag-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            fetchRecipes(1);
        }

        // Reset all filters
        function resetFilters() {
            document.getElementById('recipeSearch').value = '';
            document.getElementById('recipeSort').value = '';
            document.getElementById('clearSearch').style.display = 'none';
            currentFilters = { search: '', tags: [], sort: '' };
            clearAllTags();
        }

        // Search on input with debounce
        let searchDebounce;
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('recipeSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchDebounce);
                    searchDebounce = setTimeout(() => applyFilters(), 300);
                });
            }

            // Load initial recipes
            fetchRecipes(1);

            // Initialize settings schedule form
            renderSettingsScheduleForm();

            // Initialize visible meals settings
            renderVisibleMealsSettings();

            // Load excluded ingredients from server
            loadExcludedIngredients();

            // Initialize household settings from localStorage
            const savedPortions = localStorage.getItem('householdPortions');
            const savedCalorieLimit = localStorage.getItem('dailyCalorieLimit');
            if (savedPortions) {
                const el = document.getElementById('settingsPortions');
                if (el) el.value = savedPortions;
            }
            if (savedCalorieLimit) {
                const el = document.getElementById('settingsCalorieLimit');
                if (el) el.value = savedCalorieLimit;
            }
        });
    </script>

    <script>
        // ==============================
        // Navigation: Sidebar + Tab Bar
        // ==============================
        function scrollToSection(id) {
            const el = document.getElementById(id);
            if (el) el.scrollIntoView({ behavior: 'smooth' });
            setActiveTab(id);
        }

        function setActiveTab(id) {
            document.querySelectorAll('.nav-link, .tab-item').forEach(el => {
                el.classList.toggle('active', el.dataset.section === id);
            });
        }

        // IntersectionObserver: highlight active tab as sections scroll into view
        (function initNavObserver() {
            const observer = new IntersectionObserver(entries => {
                entries.forEach(e => {
                    if (e.isIntersecting) setActiveTab(e.target.id);
                });
            }, { threshold: 0.3 });
            ['plan', 'recipes', 'shopping', 'settings'].forEach(id => {
                const el = document.getElementById(id);
                if (el) observer.observe(el);
            });
        })();

        // ==============================
        // FAB
        // ==============================
        function toggleFab() {
            const container = document.getElementById('fabContainer');
            container.classList.toggle('fab-open');
        }

        function closeFab() {
            document.getElementById('fabContainer').classList.remove('fab-open');
        }

        // Close FAB on outside click
        document.addEventListener('click', function(e) {
            const container = document.getElementById('fabContainer');
            if (container && !container.contains(e.target)) {
                container.classList.remove('fab-open');
            }
        });

        // Close FAB on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeFab();
        });

        // ==============================
        // Settings
        // ==============================
        function renderSettingsScheduleForm() {
            const schedule = getCustomSchedule();
            const formEl = document.getElementById('settingsScheduleFormContent');
            if (!formEl) return;

            formEl.innerHTML = DAYS_OF_WEEK.map(day => `
                <div class="card">
                    <h3 style="font-weight: 600; margin-bottom: 1rem; color: var(--color-text); font-size: 1rem;">${day}</h3>
                    <div style="display: grid; gap: 0.5rem;">
                        ${['breakfast', 'lunch', 'dinner', 'snack'].map(mealType => {
                            const slotData = schedule[day]?.[mealType];
                            const servings = slotData ? slotData.servings : '';
                            const isWeekday = !['Saturday', 'Sunday'].includes(day);
                            const canCook = slotData ? slotData.can_cook : !(isWeekday && mealType === 'lunch');
                            const isEnabled = servings !== '';
                            return `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input
                                        type="checkbox"
                                        id="set_enable_${day}_${mealType}"
                                        ${isEnabled ? 'checked' : ''}
                                        onchange="toggleSettingsMealSlot('${day}', '${mealType}')"
                                        style="width: 18px; height: 18px; cursor: pointer;">
                                    <label for="set_enable_${day}_${mealType}" style="flex: 1; text-transform: capitalize; margin: 0; cursor: pointer; font-size: 0.875rem;">${mealType}</label>
                                    <input
                                        type="number"
                                        id="set_servings_${day}_${mealType}"
                                        value="${servings}"
                                        min="0.5"
                                        step="0.5"
                                        placeholder="servings"
                                        ${!isEnabled ? 'disabled' : ''}
                                        style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 0.875rem;">
                                    <button class="cook-mode-btn"
                                            id="set_cook_mode_${day}_${mealType}"
                                            data-can-cook="${canCook}"
                                            onclick="toggleCookMode(this)"
                                            ${!isEnabled ? 'disabled' : ''}
                                            title="${canCook ? 'Can cook (click to set Reheat only)' : 'Reheat only (click to set Can cook)'}">${canCook ? 'üç≥' : 'üî•'}</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleSettingsMealSlot(day, mealType) {
            const checkbox = document.getElementById(`set_enable_${day}_${mealType}`);
            const servingsInput = document.getElementById(`set_servings_${day}_${mealType}`);
            const cookModeBtn = document.getElementById(`set_cook_mode_${day}_${mealType}`);
            if (checkbox.checked) {
                servingsInput.disabled = false;
                if (!servingsInput.value) servingsInput.value = {{ household_portions }};
                if (cookModeBtn) cookModeBtn.disabled = false;
            } else {
                servingsInput.disabled = true;
                servingsInput.value = '';
                if (cookModeBtn) cookModeBtn.disabled = true;
            }
        }

        function saveScheduleSettings() {
            const schedule = {};
            DAYS_OF_WEEK.forEach(day => {
                schedule[day] = {};
                ['breakfast', 'lunch', 'dinner', 'snack'].forEach(mealType => {
                    const servingsInput = document.getElementById(`set_servings_${day}_${mealType}`);
                    if (servingsInput && servingsInput.value && !servingsInput.disabled) {
                        const cookModeBtn = document.getElementById(`set_cook_mode_${day}_${mealType}`);
                        schedule[day][mealType] = {
                            servings: parseFloat(servingsInput.value),
                            can_cook: cookModeBtn ? cookModeBtn.dataset.canCook === 'true' : true,
                        };
                    }
                });
            });
            saveCustomSchedule(schedule);
            // Also sync the modal form if it exists
            updateScheduleInfo();
            showMessage('Schedule saved! Click "Generate Plan" to create your meal plan.', 'success');
        }

        function saveHouseholdSettings() {
            const portionsEl = document.getElementById('settingsPortions');
            const calorieLimitEl = document.getElementById('settingsCalorieLimit');
            const maxDerivedEl = document.getElementById('settingsMaxDerived');
            if (portionsEl) localStorage.setItem('householdPortions', portionsEl.value);
            if (calorieLimitEl) localStorage.setItem('dailyCalorieLimit', calorieLimitEl.value);
            if (maxDerivedEl) localStorage.setItem('maxDerived', maxDerivedEl.value);
            showMessage('Household settings saved.', 'success');
        }

        function renderVisibleMealsSettings() {
            const el = document.getElementById('visibleMealsToggles');
            if (!el) return;
            const hidden = getHiddenMealTypes();
            el.innerHTML = ALL_MEAL_TYPES.map(mealType => `
                <label style="display: flex; align-items: center; gap: 0.625rem; cursor: pointer; font-size: 0.9375rem;">
                    <input
                        type="checkbox"
                        id="show_meal_${mealType}"
                        ${!hidden.includes(mealType) ? 'checked' : ''}
                        style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--color-primary);">
                    <span style="text-transform: capitalize;">${mealType}</span>
                </label>
            `).join('');
        }

        function saveVisibleMeals() {
            const hidden = ALL_MEAL_TYPES.filter(mealType => {
                const checkbox = document.getElementById(`show_meal_${mealType}`);
                return checkbox && !checkbox.checked;
            });
            saveHiddenMealTypes(hidden);
            renderWeeklyCalendar();
            showMessage('Meal visibility saved.', 'success');
        }

        // ==============================
        // Excluded Ingredients Settings
        // ==============================
        let excludedIngredients = [];

        async function loadExcludedIngredients() {
            try {
                const res = await csrfFetch('/excluded-ingredients');
                excludedIngredients = await res.json();
            } catch (e) {
                excludedIngredients = ['water', 'salt'];
            }
            renderExcludedTags();
        }

        function renderExcludedTags() {
            const el = document.getElementById('excludedTagsList');
            if (!el) return;
            el.innerHTML = excludedIngredients.map((item, i) => `
                <span class="excluded-tag">
                    ${item}
                    <button onclick="removeExcludedIngredient(${i})" title="Remove">√ó</button>
                </span>
            `).join('');
        }

        async function addExcludedIngredient() {
            const input = document.getElementById('excludedIngredientInput');
            const val = input.value.trim().toLowerCase();
            if (!val || excludedIngredients.includes(val)) { input.value = ''; return; }
            excludedIngredients = [...excludedIngredients, val];
            input.value = '';
            renderExcludedTags();
            await saveExcludedIngredients();
        }

        async function removeExcludedIngredient(index) {
            excludedIngredients = excludedIngredients.filter((_, i) => i !== index);
            renderExcludedTags();
            await saveExcludedIngredients();
        }

        async function saveExcludedIngredients() {
            try {
                await csrfFetch('/excluded-ingredients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: excludedIngredients }),
                });
                showMessage('Excluded ingredients saved.', 'success');
            } catch (e) {
                showMessage('Failed to save excluded ingredients.', 'error');
            }
        }

        // ==============================
        // Recipe Picker Modal (replaces openRecipeSelector prompt)
        // ==============================
        let _pickerDay = null;
        let _pickerMealType = null;
        let _pickerRecipes = [];
        let _pickerSelectedId = null;

        async function openRecipePicker(day, mealType) {
            _pickerDay = day;
            _pickerMealType = mealType;
            _pickerSelectedId = null;
            const confirmBtn = document.getElementById('recipePickerConfirm');
            if (confirmBtn) confirmBtn.disabled = true;

            document.getElementById('recipePickerTitle').textContent = `Add Recipe ‚Äî ${day} ${mealType}`;
            document.getElementById('recipePickerSearch').value = '';
            document.getElementById('recipePickerList').innerHTML = '<p style="color: var(--color-text-muted); text-align: center; padding: 2rem 0;">Loading...</p>';
            document.getElementById('recipePickerModal').classList.remove('hidden');

            try {
                const response = await csrfFetch('/api/recipes?per_page=500');
                const data = await response.json();
                _pickerRecipes = data.recipes || [];
                renderPickerList(_pickerRecipes);
            } catch (err) {
                document.getElementById('recipePickerList').innerHTML = '<p style="color: var(--color-error);">Error loading recipes.</p>';
            }
        }

        function renderPickerList(recipes) {
            const list = document.getElementById('recipePickerList');
            if (!recipes.length) {
                list.innerHTML = '<p style="color: var(--color-text-muted); text-align: center; padding: 2rem 0;">No recipes found.</p>';
                return;
            }
            list.innerHTML = recipes.map(r => {
                const tags = (r.tags || []).slice(0, 3).join(', ');
                const cal = r.calories_per_serving ? `${Math.round(r.calories_per_serving)} cal` : '';
                const thumb = r.image_url
                    ? `<img class="picker-recipe-thumb" src="${r.image_url}" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                    : '';
                return `
                    <div class="picker-recipe-row" data-id="${r.id}" onclick="selectPickerRecipe('${r.id}', this)">
                        <div class="picker-recipe-thumb" ${r.image_url ? 'style="padding:0;"' : ''}>
                            ${r.image_url ? `<img src="${r.image_url}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:var(--radius-sm);" onerror="this.parentElement.textContent='üçΩÔ∏è';">` : 'üçΩÔ∏è'}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div class="picker-recipe-name">${r.name}</div>
                            <div class="picker-recipe-meta">${[tags, cal].filter(Boolean).join(' ¬∑ ')}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterPickerRecipes() {
            const q = document.getElementById('recipePickerSearch').value.toLowerCase().trim();
            if (!q) {
                renderPickerList(_pickerRecipes);
                return;
            }
            const filtered = _pickerRecipes.filter(r =>
                r.name.toLowerCase().includes(q) ||
                (r.tags || []).some(t => t.toLowerCase().includes(q)) ||
                (r.ingredients || []).some(i => (i.name || i).toLowerCase().includes(q))
            );
            renderPickerList(filtered);
        }

        function selectPickerRecipe(id, el) {
            _pickerSelectedId = id;
            document.querySelectorAll('.picker-recipe-row').forEach(row => row.classList.remove('selected'));
            el.classList.add('selected');
            const confirmBtn = document.getElementById('recipePickerConfirm');
            if (confirmBtn) confirmBtn.disabled = false;
        }

        async function confirmRecipePicker() {
            if (!_pickerSelectedId || !_pickerDay || !_pickerMealType) return;
            const portions = parseFloat(localStorage.getItem('householdPortions') || '{{ household_portions }}');
            await addMeal(_pickerDay, _pickerMealType, _pickerSelectedId, portions);
            closeRecipePicker();
        }

        function closeRecipePicker() {
            document.getElementById('recipePickerModal').classList.add('hidden');
            _pickerSelectedId = null;
        }

        // Override the old openRecipeSelector to use the new modal
        function openRecipeSelector(day, mealType) {
            openRecipePicker(day, mealType);
        }

        // Override generatePlan to include household settings
        const _origGeneratePlan = generatePlan;
        window.generatePlan = async function() {
            // Patch the fetch to include portions and calorie_limit
            const origFetch = window.fetch;
            window.fetch = function(url, opts) {
                if (typeof url === 'string' && url.includes('/generate-with-schedule')) {
                    try {
                        const body = JSON.parse(opts.body);
                        body.portions = parseFloat(localStorage.getItem('householdPortions') || {{ household_portions }});
                        body.calorie_limit = parseFloat(localStorage.getItem('dailyCalorieLimit') || 1600);
                        body.max_derived = parseInt(localStorage.getItem('maxDerived') || {{ config.COOK_ONCE_MAX_DERIVED }}, 10);
                        opts.body = JSON.stringify(body);
                    } catch(e) {}
                }
                return origFetch.call(this, url, opts);
            };
            try {
                await _origGeneratePlan();
            } finally {
                window.fetch = origFetch;
            }
        };
    </script>

    <!-- FAB -->
    <div class="fab-container" id="fabContainer">
        <div class="fab-options" id="fabOptions">
            <button class="fab-option" onclick="closeFab(); openImportModal('photo')">üì∑ From Photo</button>
            <button class="fab-option" onclick="closeFab(); openImportModal('url')">üîó From URL</button>
            <button class="fab-option" onclick="closeFab(); openCreateRecipeModal()">‚úèÔ∏è Create Recipe</button>
        </div>
        <button class="fab" id="fabBtn" onclick="toggleFab()" aria-label="Add recipe">
            <span class="fab-icon">+</span>
        </button>
    </div>

    <!-- Bottom Tab Bar (mobile) -->
    <nav class="bottom-tab-bar">
        <a class="tab-item active" data-section="plan" onclick="scrollToSection('plan')">
            <span>üìã</span><span>Plan</span>
        </a>
        <a class="tab-item" data-section="recipes" onclick="scrollToSection('recipes')">
            <span>ü•ó</span><span>Recipes</span>
        </a>
        <a class="tab-item" data-section="shopping" onclick="scrollToSection('shopping')">
            <span>üõí</span><span>Shopping</span>
        </a>
        <a class="tab-item" data-section="settings" onclick="scrollToSection('settings')">
            <span>‚öôÔ∏è</span><span>Settings</span>
        </a>
    </nav>

    <!-- Recipe Picker Modal -->
    <div id="recipePickerModal" class="modal hidden">
        <div class="modal-content" style="max-width: 640px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2 class="modal-title" id="recipePickerTitle">Choose a Recipe</h2>
                <button class="modal-close" onclick="closeRecipePicker()">&times;</button>
            </div>
            <div style="padding: 1rem 2rem; border-bottom: 1px solid var(--color-border);">
                <input type="search" id="recipePickerSearch" placeholder="Search recipes..."
                       oninput="filterPickerRecipes()"
                       style="width:100%; padding: 0.625rem 0.875rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem; font-family: inherit;">
            </div>
            <div id="recipePickerList" style="overflow-y: auto; flex: 1; padding: 1rem 2rem; display: grid; gap: 0.5rem;">
                <!-- Recipe rows rendered by JS -->
            </div>
            <div style="padding: 1rem 2rem; border-top: 1px solid var(--color-border); display: flex; gap: 0.75rem; justify-content: flex-end;">
                <button class="btn btn-outline" onclick="closeRecipePicker()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRecipePicker()" id="recipePickerConfirm" disabled>
                    Add to Plan
                </button>
            </div>
        </div>
    </div>

    <style>
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Recipe picker rows */
        .picker-recipe-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--radius-md);
            border: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
        }

        .picker-recipe-row:hover {
            background: var(--color-primary-light);
            border-color: var(--color-primary-light);
        }

        .picker-recipe-row.selected {
            background: var(--color-primary-light);
            border-color: var(--color-primary);
        }

        .picker-recipe-thumb {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            background: var(--color-border);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .picker-recipe-name {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--color-text);
        }

        .picker-recipe-meta {
            font-size: 0.8125rem;
            color: var(--color-text-muted);
            margin-top: 0.125rem;
        }
    </style>
</body>
</html>
