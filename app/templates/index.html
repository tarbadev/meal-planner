<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Planner ‚Äì Your Weekly Menu Made Easy</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Weekly meal planning with shopping list generation">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Meals">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">

    <!-- Favicon and Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <link rel="apple-touch-icon" href="/static/icon-192.png">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primary: #059669;
            --color-primary-dark: #047857;
            --color-primary-light: #d1fae5;
            --color-accent: #f97316;
            --color-accent-light: #fed7aa;
            --color-background: #fafaf9;
            --color-surface: #ffffff;
            --color-text: #1c1917;
            --color-text-light: #57534e;
            --color-text-muted: #a8a29e;
            --color-border: #e7e5e4;
            --color-error: #dc2626;
            --color-success: #059669;
            --color-warning: #f59e0b;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;

            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--color-text);
            background: linear-gradient(135deg, #fafaf9 0%, #f5f5f4 50%, #fef3c7 100%);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header */
        .header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--color-text);
            line-height: 1;
        }

        .logo-text p {
            font-size: 0.875rem;
            color: var(--color-text-muted);
            margin-top: 0.125rem;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            border-radius: var(--radius-xl);
            padding: 3rem;
            margin-bottom: 3rem;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .hero h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .hero p {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: 2rem;
            max-width: 600px;
        }

        .hero-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            min-height: 44px;
            white-space: nowrap;
        }

        .btn-primary {
            background: white;
            color: var(--color-primary);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-accent {
            background: var(--color-accent);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-accent:hover {
            background: #ea580c;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--color-border);
            color: var(--color-text);
        }

        .btn-outline:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-icon {
            font-size: 1.25rem;
        }

        /* Section */
        .section {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.875rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .section-subtitle {
            color: var(--color-text-muted);
            font-size: 0.9375rem;
            margin-top: 0.25rem;
        }

        /* Cards */
        .card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary-light);
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        /* Week Calendar */
        .week-calendar {
            display: grid;
            gap: 1rem;
            position: relative;
        }

        /* Landscape mode: Show all days in a grid */
        @media (min-width: 768px) and (orientation: landscape), (min-width: 1024px) {
            .week-calendar {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .calendar-nav {
                display: none;
            }

            .day-card {
                display: block !important;
            }
        }

        /* Portrait mode: Show one day at a time */
        @media (max-width: 767px), (max-width: 1023px) and (orientation: portrait) {
            .week-calendar {
                grid-template-columns: 1fr;
                overflow: hidden;
            }

            .day-card {
                display: none;
            }

            .day-card.active {
                display: block;
                animation: slideIn 0.3s ease-out;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateX(20px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
        }

        /* Calendar Navigation Controls */
        .calendar-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
            border: 1px solid var(--color-border);
        }

        .calendar-nav-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.25rem;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .calendar-nav-btn:hover:not(:disabled) {
            background: var(--color-primary-dark);
            transform: scale(1.05);
        }

        .calendar-nav-btn:disabled {
            background: var(--color-border);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .calendar-nav-center {
            flex: 1;
            text-align: center;
            padding: 0 1rem;
        }

        .calendar-current-day {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 0.25rem;
        }

        .calendar-day-progress {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-border);
            transition: var(--transition);
        }

        .progress-dot.active {
            background: var(--color-primary);
            width: 10px;
            height: 10px;
        }

        .swipe-hint {
            text-align: center;
            color: var(--color-text-light);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            opacity: 0;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .day-card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--color-border);
            transition: var(--transition);
        }

        .day-card:hover {
            box-shadow: var(--shadow-md);
        }

        .day-header {
            background: linear-gradient(135deg, var(--color-primary-light) 0%, #d1fae5 100%);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-header.over-limit {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
        }

        .day-name {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--color-text);
        }

        .day-calories {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--color-text-light);
        }

        .calorie-badge {
            background: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-weight: 500;
        }

        .day-meals {
            padding: 1rem;
            display: grid;
            gap: 0.75rem;
        }

        .meal-slot {
            background: var(--color-background);
            border-radius: var(--radius-md);
            padding: 1rem;
            border: 2px dashed var(--color-border);
            transition: var(--transition);
        }

        .meal-slot.has-meal {
            border-style: solid;
            border-color: var(--color-primary-light);
            background: white;
        }

        .meal-slot:hover {
            border-color: var(--color-primary);
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .meal-type {
            text-transform: uppercase;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: var(--color-text-muted);
        }

        .meal-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: var(--radius-sm);
            min-height: 32px;
        }

        .meal-content {
            margin-top: 0.75rem;
        }

        .meal-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--color-text);
            margin-bottom: 0.5rem;
        }

        .meal-name a {
            color: inherit;
            text-decoration: none;
            transition: var(--transition);
        }

        .meal-name a:hover {
            color: var(--color-primary);
        }

        .meal-nutrition {
            display: flex;
            gap: 1rem;
            font-size: 0.8125rem;
            color: var(--color-text-light);
        }

        .meal-nutrition span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .empty-slot {
            text-align: center;
            padding: 1.5rem;
        }

        .empty-slot-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.3;
        }

        .empty-slot-text {
            color: var(--color-text-muted);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        /* Recipe List */
        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .recipe-card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--color-border);
            transition: var(--transition);
            cursor: pointer;
        }

        .recipe-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }

        .recipe-image {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, var(--color-primary-light) 0%, var(--color-accent-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            object-fit: cover;
            position: relative;
            overflow: hidden;
        }

        .recipe-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .recipe-image-emoji {
            font-size: 4rem;
        }

        .recipe-content {
            padding: 1.25rem;
        }

        .recipe-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            color: var(--color-text);
        }

        .recipe-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--color-text-light);
            margin-bottom: 0.75rem;
        }

        .recipe-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            background: var(--color-primary-light);
            color: var(--color-primary-dark);
            padding: 0.25rem 0.625rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Tag Filter Buttons */
        .tag-filter {
            padding: 0.375rem 0.875rem;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text);
            cursor: pointer;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .tag-filter:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .tag-filter.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Clear All Button */
        .clear-all-btn {
            padding: 0.375rem 0.875rem;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .clear-all-btn:hover {
            border-color: var(--color-error);
            color: var(--color-error);
            background: #fee;
        }

        /* Shopping List */
        .shopping-list {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--color-border);
        }

        .shopping-category {
            margin-bottom: 1.5rem;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--color-border);
        }

        .category-icon {
            font-size: 1.5rem;
        }

        .category-name {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--color-text);
        }

        .shopping-items {
            display: grid;
            gap: 0.75rem;
        }

        .shopping-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--color-background);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .shopping-item:hover {
            background: var(--color-primary-light);
        }

        .shopping-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }

        .shopping-item.checked {
            opacity: 0.5;
        }

        .shopping-item.checked .item-text {
            text-decoration: line-through;
        }

        .item-text {
            flex: 1;
            color: var(--color-text);
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: var(--transition);
        }

        .shopping-item:hover .item-actions {
            opacity: 1;
        }

        .item-action-btn {
            background: none;
            border: none;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 1.125rem;
            transition: var(--transition);
            border-radius: var(--radius-sm);
        }

        .item-action-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .item-edit-mode {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .item-edit-input {
            padding: 0.375rem 0.5rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            background: white;
        }

        .item-edit-input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .item-quantity-input {
            width: 60px;
        }

        .item-name-input {
            flex: 1;
            min-width: 120px;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        .hidden {
            display: none !important;
        }

        .modal.hidden {
            display: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-xl);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 2rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--color-background);
            color: var(--color-text);
        }

        .modal-body {
            padding: 2rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--color-border);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            color: var(--color-text-muted);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .tab:hover {
            color: var(--color-text);
            background: var(--color-background);
        }

        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--color-text);
        }

        input[type="text"],
        input[type="url"],
        input[type="number"],
        input[type="file"],
        textarea,
        select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
            background: var(--color-surface);
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-light);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-hint {
            font-size: 0.875rem;
            color: var(--color-text-muted);
            margin-top: 0.5rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
            font-size: 0.9375rem;
            line-height: 1.5;
        }

        .status-message.success {
            background: var(--color-primary-light);
            color: var(--color-primary-dark);
            border-left: 4px solid var(--color-primary);
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--color-error);
        }

        .status-message.warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--color-warning);
        }

        .status-message.hidden {
            display: none;
        }

        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, var(--color-primary-light) 0%, #dbeafe 100%);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--color-primary);
        }

        .info-box-title {
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-box-content {
            font-size: 0.9375rem;
            color: var(--color-text-light);
            line-height: 1.6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header-content {
                padding: 1rem;
            }

            .hero {
                padding: 2rem 1.5rem;
            }

            .hero h2 {
                font-size: 1.875rem;
            }

            .hero-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .recipe-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-width: 100%;
                border-radius: var(--radius-lg);
            }

            .form-actions {
                flex-direction: column;
            }

            /* Recipe Filter Responsive Styles */
            .recipe-filters > div:first-child {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }

            .recipe-filters select {
                width: 100%;
            }

            .recipe-filters input {
                font-size: 16px !important; /* Prevent iOS zoom on focus */
            }

            /* Tag filters with better touch targets */
            .tag-filter,
            .clear-all-btn {
                padding: 0.625rem 1rem;
                font-size: 0.9375rem;
                min-height: 44px; /* iOS recommended touch target */
            }

            /* Pagination responsive */
            #recipePagination {
                flex-wrap: wrap;
                gap: 0.375rem !important;
            }

            #recipePagination button {
                min-width: 44px;
                min-height: 44px;
                padding: 0.5rem;
            }

            #recipePagination span {
                padding: 0 0.25rem !important;
            }

            /* Hide page number ellipsis on very small screens */
            @media (max-width: 480px) {
                #recipePagination button:not(.btn-primary):not(:first-child):not(:last-child) {
                    display: none;
                }

                #recipePagination span {
                    display: none;
                }
            }

            /* Recipe cards already single column, ensure proper spacing */
            .recipe-card {
                margin-bottom: 0;
            }

            /* Adjust quick stats grid on mobile */
            .grid-3 {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
        }

        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 0.5rem;
        }

        .empty-state-text {
            color: var(--color-text-muted);
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üç≥</div>
                <div class="logo-text">
                    <h1>Meal Planner</h1>
                    <p>Plan smarter, eat better</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-content">
                <h2>Your Weekly Menu, Simplified</h2>
                <p>Import recipes from anywhere, plan your week, generate shopping lists automatically, and track nutrition‚Äîall in one beautiful app.</p>
                <div class="hero-actions">
                    <button class="btn btn-primary" onclick="openImportModal()">
                        <span class="btn-icon">üì•</span>
                        Import Recipe
                    </button>
                    <button class="btn btn-primary" onclick="openCreateRecipeModal()">
                        <span class="btn-icon">‚ûï</span>
                        Create Recipe
                    </button>
                    <button class="btn btn-secondary" onclick="openScheduleConfig()">
                        <span class="btn-icon">‚öôÔ∏è</span>
                        Configure Schedule
                    </button>
                </div>
            </div>
        </section>

        <!-- Quick Stats -->
        {% if current_plan %}
        <div class="grid grid-3" style="margin-bottom: 3rem;">
            <div class="card">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; background: var(--color-primary-light); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üìã</div>
                    <div>
                        <div style="font-size: 0.875rem; color: var(--color-text-muted);">This Week</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-text);">{{ current_plan.meals|length }} Meals</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; background: var(--color-accent-light); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üî•</div>
                    <div>
                        <div style="font-size: 0.875rem; color: var(--color-text-muted);">Avg Daily</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-text);">{{ current_plan.daily_averages.calories|int }} cal</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; background: #dbeafe; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üõí</div>
                    <div>
                        <div style="font-size: 0.875rem; color: var(--color-text-muted);">Shopping Items</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-text);">{{ current_shopping_list.items|length if current_shopping_list else 0 }}</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Weekly Plan Section -->
        <section class="section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Weekly Plan</h2>
                    <p class="section-subtitle" id="scheduleInfo">Click "Configure Schedule" to set your meals</p>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button id="generateBtn" class="btn btn-accent" onclick="generatePlan()">
                        <span class="btn-icon">üé≤</span>
                        Generate Plan
                    </button>
                    <button class="btn btn-outline" onclick="clearWeek()">
                        <span class="btn-icon">üóëÔ∏è</span>
                        Clear Week
                    </button>
                </div>
            </div>

            <!-- Mobile/Portrait Navigation -->
            <div id="calendarNav" class="calendar-nav" style="display: none;">
                <button id="prevDayBtn" class="calendar-nav-btn" onclick="navigateDay(-1)">
                    ‚Äπ
                </button>
                <div class="calendar-nav-center">
                    <div id="currentDayName" class="calendar-current-day"></div>
                    <div id="dayProgress" class="calendar-day-progress"></div>
                </div>
                <button id="nextDayBtn" class="calendar-nav-btn" onclick="navigateDay(1)">
                    ‚Ä∫
                </button>
            </div>
            <div id="swipeHint" class="swipe-hint">Swipe left or right to navigate days</div>

            <div id="weeklyCalendar" class="week-calendar">
                <!-- Calendar will be rendered by JavaScript -->
            </div>
        </section>

        <!-- Shopping List Section -->
        {% if current_shopping_list %}
        <section class="section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Shopping List</h2>
                    <p class="section-subtitle"><span id="shoppingListCount">{{ current_shopping_list.items|length }}</span> items for this week</p>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button class="btn btn-primary" onclick="openAddItemModal()">
                        <span class="btn-icon">+</span>
                        Add Item
                    </button>
                    <button class="btn btn-outline" onclick="uncheckAllShoppingItems()">
                        Reset Checks
                    </button>
                </div>
            </div>

            <div id="shoppingListContainer" class="shopping-list">
                <!-- Will be rendered by JavaScript -->
            </div>
        </section>
        {% endif %}

        <!-- Recipe Library Section -->
        <section class="section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Recipe Library</h2>
                    <p class="section-subtitle" id="recipeCount">Loading recipes...</p>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="recipe-filters" style="margin-bottom: 2rem;">
                <!-- Search Bar -->
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <div style="flex: 1; position: relative;">
                        <input
                            type="text"
                            id="recipeSearch"
                            placeholder="Search recipes by name or tags..."
                            style="width: 100%; padding: 0.75rem 2.5rem 0.75rem 1rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem;"
                        >
                        <button
                            id="clearSearch"
                            onclick="clearSearch()"
                            style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--color-text-muted); cursor: pointer; padding: 0.5rem; display: none;"
                        >‚úï</button>
                    </div>
                    <select
                        id="recipeSort"
                        onchange="applyFilters()"
                        style="padding: 0.75rem 1rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 1rem; background: white;"
                    >
                        <option value="">Sort by...</option>
                        <option value="name_asc">Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                        <option value="calories_asc">Calories (Low to High)</option>
                        <option value="calories_desc">Calories (High to Low)</option>
                        <option value="time_asc">Time (Quick First)</option>
                        <option value="time_desc">Time (Long First)</option>
                    </select>
                </div>

                <!-- Tag Filters -->
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                    <span style="color: var(--color-text-muted); font-size: 0.875rem; line-height: 2rem;">Quick filters:</span>
                    <button class="tag-filter" data-tag="quick" onclick="toggleTagFilter(this)">‚ö° Quick</button>
                    <button class="tag-filter" data-tag="vegetarian" onclick="toggleTagFilter(this)">ü•¨ Vegetarian</button>
                    <button class="tag-filter" data-tag="vegan" onclick="toggleTagFilter(this)">üå± Vegan</button>
                    <button class="tag-filter" data-tag="italian" onclick="toggleTagFilter(this)">üçù Italian</button>
                    <button class="tag-filter" data-tag="mexican" onclick="toggleTagFilter(this)">üåÆ Mexican</button>
                    <button class="tag-filter" data-tag="asian" onclick="toggleTagFilter(this)">üçú Asian</button>
                    <button class="tag-filter" data-tag="breakfast" onclick="toggleTagFilter(this)">ü•û Breakfast</button>
                    <button class="tag-filter" data-tag="dessert" onclick="toggleTagFilter(this)">üç∞ Dessert</button>
                    <button class="tag-filter" data-tag="salad" onclick="toggleTagFilter(this)">ü•ó Salad</button>
                    <button class="clear-all-btn" onclick="clearAllTags()">Clear All</button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="recipeLoading" style="text-align: center; padding: 3rem; display: none;">
                <div style="font-size: 3rem;">‚è≥</div>
                <p style="color: var(--color-text-muted); margin-top: 1rem;">Loading recipes...</p>
            </div>

            <!-- Empty State -->
            <div id="recipeEmpty" style="display: none;">
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <h3 class="empty-state-title">No recipes found</h3>
                    <p class="empty-state-text">Try adjusting your search or filters</p>
                    <button class="btn btn-outline" onclick="resetFilters()">Clear Filters</button>
                </div>
            </div>

            <!-- Recipe Grid (populated by JavaScript) -->
            <div id="recipeGrid" class="recipe-grid"></div>

            <!-- Pagination -->
            <div id="recipePagination" style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 2rem;"></div>
        </section>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Import Recipe</h2>
                <button class="modal-close" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="switchImportTab('url')">üîó From URL</button>
                    <button class="tab" onclick="switchImportTab('text')">üìù From Text</button>
                    <button class="tab" onclick="switchImportTab('photo')">üì∑ From Photo</button>
                </div>

                <!-- URL Import Form -->
                <form id="importRecipeForm" onsubmit="handleImportFormSubmit(event)">
                    <div class="form-group">
                        <label for="recipeUrl">Recipe URL</label>
                        <input type="url" id="recipeUrl" placeholder="https://example.com/recipe or Instagram URL" required>
                        <p class="form-hint">Supports recipe websites and Instagram posts</p>
                    </div>

                    <div id="importStatus" class="status-message hidden"></div>

                    <div class="form-actions">
                        <button type="submit" id="importBtn" class="btn btn-primary" style="flex: 1;">Import Recipe</button>
                        <button type="button" class="btn btn-outline" onclick="closeImportModal()">Cancel</button>
                    </div>
                </form>

                <!-- Text Import Form -->
                <form id="importTextForm" class="hidden" onsubmit="handleTextImportFormSubmit(event)">
                    <div class="form-group">
                        <label for="recipeText">Recipe Text</label>
                        <textarea id="recipeText" placeholder="Paste the recipe text here..." rows="8" required></textarea>
                        <p class="form-hint">Paste Instagram post text, recipe from email, or any recipe text. AI will extract the structured data.</p>
                    </div>

                    <div id="importTextStatus" class="status-message hidden"></div>

                    <div class="form-actions">
                        <button type="submit" id="importTextBtn" class="btn btn-primary" style="flex: 1;">Import from Text</button>
                        <button type="button" class="btn btn-outline" onclick="closeImportModal()">Cancel</button>
                    </div>
                </form>

                <!-- Photo Import Form -->
                <form id="importPhotoForm" class="hidden" onsubmit="handlePhotoImportFormSubmit(event)">
                    <div class="form-group">
                        <label for="recipePhoto">Recipe Photo</label>
                        <input type="file" id="recipePhoto" accept="image/*" capture="environment" required>
                        <p class="form-hint">Take a photo or upload an image of a recipe card, cookbook page, or handwritten recipe.</p>
                    </div>

                    <div id="photoPreview" style="display: none; margin-top: 1rem;">
                        <img id="photoPreviewImg" style="max-width: 100%; border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                    </div>

                    <div id="importPhotoStatus" class="status-message hidden"></div>

                    <div class="form-actions">
                        <button type="submit" id="importPhotoBtn" class="btn btn-primary" style="flex: 1;">Import from Photo</button>
                        <button type="button" class="btn btn-outline" onclick="closeImportModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Schedule Configuration Modal -->
    <div id="scheduleModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Configure Weekly Schedule</h2>
                <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <div class="info-box-title">
                        <span>üí°</span>
                        How it works
                    </div>
                    <div class="info-box-content">
                        Set which meals you need each day and how many servings. This tells the generator what to plan for your week.
                    </div>
                </div>
                <div id="scheduleConfigForm" style="display: grid; gap: 1rem;"></div>
                <div class="form-actions">
                    <button onclick="saveScheduleConfig()" class="btn btn-primary" style="flex: 1;">Save Schedule</button>
                    <button type="button" onclick="closeScheduleModal()" class="btn btn-outline">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Recipe Modal -->
    <div id="createRecipeModal" class="modal hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Create Recipe</h2>
                <button class="modal-close" onclick="closeCreateRecipeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createRecipeForm" onsubmit="handleCreateRecipeSubmit(event)">
                    <div class="form-group">
                        <label for="recipeName">Recipe Name *</label>
                        <input type="text" id="recipeName" required placeholder="e.g., Chicken Stir Fry">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="recipeServings">Servings *</label>
                            <input type="number" id="recipeServings" required min="1" step="0.5" value="4">
                        </div>
                        <div class="form-group">
                            <label for="recipePrepTime">Prep Time (min)</label>
                            <input type="number" id="recipePrepTime" min="0" value="15">
                        </div>
                        <div class="form-group">
                            <label for="recipeCookTime">Cook Time (min)</label>
                            <input type="number" id="recipeCookTime" min="0" value="30">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="recipeIngredients">Ingredients *</label>
                        <div id="ingredientsList" style="display: grid; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <input type="text" class="ingredient-input" placeholder="e.g., 2 cups chicken breast, diced" required>
                        </div>
                        <button type="button" class="btn btn-outline btn-small" onclick="addIngredientField()">
                            + Add Ingredient
                        </button>
                        <p class="form-hint">Add one ingredient per line</p>
                    </div>

                    <div class="form-group">
                        <label for="recipeInstructions">Instructions *</label>
                        <div id="instructionsList" style="display: grid; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <textarea class="instruction-input" rows="2" placeholder="Step 1: Heat oil in a pan..." required></textarea>
                        </div>
                        <button type="button" class="btn btn-outline btn-small" onclick="addInstructionField()">
                            + Add Step
                        </button>
                        <p class="form-hint">Add one step per box</p>
                    </div>

                    <div class="form-group">
                        <label for="recipeTags">Tags (comma-separated)</label>
                        <input type="text" id="recipeTags" placeholder="e.g., dinner, asian, quick">
                        <p class="form-hint">Optional: Add tags to help organize and find this recipe</p>
                    </div>

                    <div class="form-group">
                        <label for="recipeSourceUrl">Source URL</label>
                        <input type="url" id="recipeSourceUrl" placeholder="https://example.com/recipe">
                        <p class="form-hint">Optional: Link to the original recipe</p>
                    </div>

                    <div class="form-group">
                        <label for="recipeImageUrl">Image URL</label>
                        <input type="url" id="recipeImageUrl" placeholder="https://example.com/image.jpg">
                        <p class="form-hint">Optional: Link to an image of the dish</p>
                    </div>

                    <div id="createRecipeStatus" class="status-message hidden"></div>

                    <div class="form-actions">
                        <button type="submit" id="createRecipeBtn" class="btn btn-primary" style="flex: 1;">Create Recipe</button>
                        <button type="button" class="btn btn-outline" onclick="closeCreateRecipeModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration from backend
        const DAYS_OF_WEEK = {{ config.DAYS_OF_WEEK | tojson }};
        const MEAL_SCHEDULE = {{ config.MEAL_SCHEDULE | tojson }};
        let currentPlanData = {% if current_plan %}{{ current_plan | tojson }}{% else %}null{% endif %};
        let currentShoppingList = {% if current_shopping_list %}{{ current_shopping_list.items | tojson }}{% else %}[]{% endif %};

        // Schedule management functions
        function getCustomSchedule() {
            const stored = localStorage.getItem('customSchedule');
            if (stored) {
                return JSON.parse(stored);
            }
            // Default: use config schedule with default servings
            const schedule = {};
            Object.keys(MEAL_SCHEDULE).forEach(day => {
                schedule[day] = {};
                MEAL_SCHEDULE[day].forEach(mealType => {
                    schedule[day][mealType] = {{ household_portions }};
                });
            });
            return schedule;
        }

        function saveCustomSchedule(schedule) {
            localStorage.setItem('customSchedule', JSON.stringify(schedule));
            updateScheduleInfo();
        }

        function updateScheduleInfo() {
            const schedule = getCustomSchedule();
            const infoEl = document.getElementById('scheduleInfo');

            let totalMeals = 0;
            let scheduleText = [];

            Object.entries(schedule).forEach(([day, meals]) => {
                const mealCount = Object.keys(meals).length;
                if (mealCount > 0) {
                    totalMeals += mealCount;
                }
            });

            if (totalMeals > 0) {
                infoEl.innerHTML = `Configured for ${totalMeals} meals across the week`;
            } else {
                infoEl.innerHTML = 'Click "Configure Schedule" to set your meals';
            }
        }

        function openScheduleConfig() {
            const schedule = getCustomSchedule();
            const formEl = document.getElementById('scheduleConfigForm');

            formEl.innerHTML = DAYS_OF_WEEK.map(day => `
                <div class="card">
                    <h3 style="font-weight: 600; margin-bottom: 1rem; color: var(--color-text);">${day}</h3>
                    <div style="display: grid; gap: 0.75rem;">
                        ${['breakfast', 'lunch', 'dinner', 'snack'].map(mealType => {
                            const servings = schedule[day]?.[mealType] || '';
                            const isEnabled = servings !== '';
                            return `
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <input
                                        type="checkbox"
                                        id="enable_${day}_${mealType}"
                                        ${isEnabled ? 'checked' : ''}
                                        onchange="toggleMealSlot('${day}', '${mealType}')"
                                        style="width: 20px; height: 20px; cursor: pointer;">
                                    <label for="enable_${day}_${mealType}" style="flex: 1; text-transform: capitalize; margin: 0; cursor: pointer;">${mealType}</label>
                                    <input
                                        type="number"
                                        id="servings_${day}_${mealType}"
                                        value="${servings}"
                                        min="0.5"
                                        step="0.5"
                                        placeholder="servings"
                                        ${!isEnabled ? 'disabled' : ''}
                                        style="width: 100px;">
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');

            document.getElementById('scheduleModal').classList.remove('hidden');
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.add('hidden');
        }

        function toggleMealSlot(day, mealType) {
            const checkbox = document.getElementById(`enable_${day}_${mealType}`);
            const servingsInput = document.getElementById(`servings_${day}_${mealType}`);

            if (checkbox.checked) {
                servingsInput.disabled = false;
                if (!servingsInput.value) {
                    servingsInput.value = {{ household_portions }};
                }
            } else {
                servingsInput.disabled = true;
                servingsInput.value = '';
            }
        }

        function saveScheduleConfig() {
            const schedule = {};

            DAYS_OF_WEEK.forEach(day => {
                schedule[day] = {};
                ['breakfast', 'lunch', 'dinner', 'snack'].forEach(mealType => {
                    const servingsInput = document.getElementById(`servings_${day}_${mealType}`);
                    if (servingsInput && servingsInput.value && !servingsInput.disabled) {
                        schedule[day][mealType] = parseFloat(servingsInput.value);
                    }
                });
            });

            saveCustomSchedule(schedule);
            closeScheduleModal();
            showMessage('Schedule saved! Click "Generate Plan" to create your meal plan.', 'success');
        }

        // Generate meal plan
        async function generatePlan() {
            const btn = document.getElementById('generateBtn');
            if (!btn) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Generating...';

            try {
                const schedule = getCustomSchedule();

                // Clear existing manual plan first
                await fetch('/manual-plan/clear', { method: 'POST' });

                // Generate plan with custom schedule
                const response = await fetch('/generate-with-schedule', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ schedule })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Meal plan generated! You can now edit individual meals.', 'success');
                    await loadCurrentPlan();
                } else if (data.error) {
                    showMessage('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Error generating plan: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="btn-icon">üé≤</span> Generate Plan';
            }
        }

        // Clear week
        async function clearWeek() {
            if (!confirm('Clear all meals for this week?')) return;

            try {
                await fetch('/manual-plan/clear', { method: 'POST' });
                showMessage('Week cleared', 'success');
                window.location.reload();
            } catch (error) {
                showMessage('Error clearing week: ' + error.message, 'error');
            }
        }

        // Load current plan
        async function loadCurrentPlan() {
            try {
                const response = await fetch('/current-plan');
                const data = await response.json();

                if (data.plan) {
                    currentPlanData = data.plan;
                    renderWeeklyCalendar(data.plan);
                }

                if (data.shopping_list) {
                    currentShoppingList = data.shopping_list.items;
                    renderShoppingList();
                }
            } catch (error) {
                console.error('Error loading plan:', error);
            }
        }

        // Current day index for portrait mode navigation
        let currentDayIndex = 0;

        // Detect if we're in portrait/mobile mode
        function isPortraitMode() {
            return window.matchMedia('(max-width: 767px), (max-width: 1023px) and (orientation: portrait)').matches;
        }

        // Navigate between days in portrait mode
        function navigateDay(direction) {
            currentDayIndex = Math.max(0, Math.min(DAYS_OF_WEEK.length - 1, currentDayIndex + direction));
            updateDayView();
        }

        // Update the visible day and navigation controls
        function updateDayView() {
            if (!isPortraitMode()) return;

            const dayCards = document.querySelectorAll('.day-card');
            dayCards.forEach((card, index) => {
                card.classList.toggle('active', index === currentDayIndex);
            });

            const currentDay = DAYS_OF_WEEK[currentDayIndex];
            document.getElementById('currentDayName').textContent = currentDay;
            document.getElementById('prevDayBtn').disabled = currentDayIndex === 0;
            document.getElementById('nextDayBtn').disabled = currentDayIndex === DAYS_OF_WEEK.length - 1;

            const progressEl = document.getElementById('dayProgress');
            progressEl.innerHTML = DAYS_OF_WEEK.map((_, i) =>
                `<span class="progress-dot ${i === currentDayIndex ? 'active' : ''}"></span>`
            ).join('');
        }

        // Setup swipe gesture detection
        let touchStartX = 0;
        let touchEndX = 0;

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    navigateDay(1);
                } else {
                    navigateDay(-1);
                }
            }
        }

        // Render weekly calendar
        function renderWeeklyCalendar(planData = null) {
            const calendarEl = document.getElementById('weeklyCalendar');
            const currentPlan = planData || currentPlanData;
            const customSchedule = getCustomSchedule();

            calendarEl.innerHTML = DAYS_OF_WEEK.map((day, index) => {
                const mealSlots = customSchedule[day] ? Object.keys(customSchedule[day]) : [];
                const dayNutrition = currentPlan?.daily_nutrition?.[day] || {};
                const dayCalories = Math.round(dayNutrition.calories || 0);
                const calorieLimit = currentPlan?.daily_calorie_limit;
                const isOverLimit = calorieLimit && dayCalories > calorieLimit;
                const limitText = calorieLimit ? ` / ${calorieLimit}` : '';

                return `
                    <div class="day-card ${isPortraitMode() && index === currentDayIndex ? 'active' : ''}">
                        <div class="day-header ${isOverLimit ? 'over-limit' : ''}">
                            <div class="day-name">${day}</div>
                            <div class="day-calories">
                                <span class="calorie-badge">${dayCalories}${limitText} cal</span>
                                ${isOverLimit ? '‚ö†Ô∏è' : ''}
                            </div>
                        </div>
                        <div class="day-meals">
                            ${mealSlots.map(mealType => renderMealSlot(day, mealType, currentPlan)).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            updateResponsiveUI();
        }

        // Update UI based on orientation/screen size
        function updateResponsiveUI() {
            const navEl = document.getElementById('calendarNav');
            const hintEl = document.getElementById('swipeHint');
            const inPortrait = isPortraitMode();

            navEl.style.display = inPortrait ? 'flex' : 'none';

            if (inPortrait) {
                updateDayView();
                if (!localStorage.getItem('swipeHintShown')) {
                    hintEl.style.display = 'block';
                    setTimeout(() => {
                        localStorage.setItem('swipeHintShown', 'true');
                    }, 3000);
                } else {
                    hintEl.style.display = 'none';
                }
            } else {
                hintEl.style.display = 'none';
            }
        }

        function renderMealSlot(day, mealType, currentPlan) {
            const meal = currentPlan?.meals?.find(m => m.day === day && m.meal_type === mealType);

            if (meal) {
                return `
                    <div class="meal-slot has-meal">
                        <div class="meal-header">
                            <div class="meal-type">${mealType}</div>
                            <div class="meal-actions">
                                <button class="btn btn-small btn-outline" onclick="editMealServings('${day}', '${mealType}', ${meal.portions || 1})">
                                    Edit
                                </button>
                                <button class="btn btn-small btn-outline" onclick="regenerateMeal('${day}', '${mealType}')" title="Regenerate with a different recipe">
                                    üîÑ
                                </button>
                                <button class="btn btn-small btn-outline" onclick="removeMeal('${day}', '${mealType}')" style="color: var(--color-error);">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                        <div class="meal-content">
                            <div class="meal-name">
                                <a href="/recipe/${meal.recipe_id}">${meal.recipe_name || 'Unnamed Recipe'}</a>
                            </div>
                            <div class="meal-nutrition">
                                <span>üî• ${meal.calories ? Math.round(meal.calories) : 0} cal</span>
                                <span>üçó ${meal.protein ? Math.round(meal.protein) : 0}g protein</span>
                                <span>üçΩÔ∏è ${meal.portions || 1} servings</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="meal-slot">
                        <div class="meal-header">
                            <div class="meal-type">${mealType}</div>
                        </div>
                        <div class="empty-slot">
                            <div class="empty-slot-icon">üçΩÔ∏è</div>
                            <div class="empty-slot-text">No meal planned</div>
                            <button class="btn btn-small btn-primary" onclick="openRecipeSelector('${day}', '${mealType}')">
                                Add Recipe
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Meal management functions
        async function addMeal(day, mealType, recipeId, servings) {
            try {
                const response = await fetch('/manual-plan/add-meal', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ day, meal_type: mealType, recipe_id: recipeId, servings })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Meal added!', 'success');
                    await loadCurrentPlan();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to add meal'), 'error');
                }
            } catch (error) {
                showMessage('Error adding meal: ' + error.message, 'error');
            }
        }

        async function removeMeal(day, mealType) {
            if (!confirm('Remove this meal?')) return;

            try {
                const response = await fetch('/manual-plan/remove-meal', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ day, meal_type: mealType })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Meal removed', 'success');
                    await loadCurrentPlan();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to remove meal'), 'error');
                }
            } catch (error) {
                showMessage('Error removing meal: ' + error.message, 'error');
            }
        }

        async function editMealServings(day, mealType, currentServings) {
            const newServings = prompt(`Enter new servings for ${mealType}:`, currentServings);
            if (!newServings || isNaN(newServings)) return;

            try {
                const response = await fetch('/manual-plan/update-servings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ day, meal_type: mealType, servings: parseFloat(newServings) })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Servings updated', 'success');
                    await loadCurrentPlan();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to update servings'), 'error');
                }
            } catch (error) {
                showMessage('Error updating servings: ' + error.message, 'error');
            }
        }

        async function regenerateMeal(day, mealType) {
            if (!confirm(`Regenerate ${mealType} with a different recipe?`)) return;

            try {
                const response = await fetch('/manual-plan/regenerate-meal', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ day, meal_type: mealType })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(`Regenerated with: ${data.recipe_name}`, 'success');
                    await loadCurrentPlan();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to regenerate meal'), 'error');
                }
            } catch (error) {
                showMessage('Error regenerating meal: ' + error.message, 'error');
            }
        }

        async function openRecipeSelector(day, mealType) {
            // Fetch all recipes from API (up to 1000)
            try {
                const response = await fetch('/api/recipes?per_page=1000');
                const data = await response.json();
                const recipes = data.recipes;

                if (recipes.length === 0) {
                    alert('No recipes available. Import a recipe first!');
                    return;
                }

                const recipeId = prompt(`Enter recipe ID or name for ${day} ${mealType}:\n\n` +
                    recipes.map(r => `- ${r.id}: ${r.name}`).join('\n'));

                if (!recipeId) return;

                const recipe = recipes.find(r => r.id === recipeId || r.name.toLowerCase().includes(recipeId.toLowerCase()));
                if (!recipe) {
                    alert('Recipe not found');
                    return;
                }

                const servings = prompt('How many servings?', {{ household_portions }});
                if (!servings || isNaN(servings)) return;

                await addMeal(day, mealType, recipe.id, parseFloat(servings));
            } catch (error) {
                console.error('Error fetching recipes:', error);
                alert('Error loading recipes. Please try again.');
            }
        }

        // Shopping list functions
        function toggleShoppingItem(checkbox) {
            const item = checkbox.closest('.shopping-item');
            if (checkbox.checked) {
                item.classList.add('checked');
            } else {
                item.classList.remove('checked');
            }
            saveShoppingListState();
        }

        function saveShoppingListState() {
            const checkboxes = document.querySelectorAll('.shopping-item input[type="checkbox"]');
            const state = Array.from(checkboxes).map(cb => cb.checked);
            localStorage.setItem('shoppingListState', JSON.stringify(state));
        }

        function loadShoppingListState() {
            const stateStr = localStorage.getItem('shoppingListState');
            if (!stateStr) return;

            try {
                const state = JSON.parse(stateStr);
                const checkboxes = document.querySelectorAll('.shopping-item input[type="checkbox"]');
                checkboxes.forEach((cb, i) => {
                    if (state[i]) {
                        cb.checked = true;
                        cb.closest('.shopping-item').classList.add('checked');
                    }
                });
            } catch (e) {
                console.error('Error loading shopping list state:', e);
            }
        }

        function uncheckAllShoppingItems() {
            const checkboxes = document.querySelectorAll('.shopping-item input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.closest('.shopping-item').classList.remove('checked');
            });
            saveShoppingListState();
        }

        // Render shopping list with edit functionality
        function renderShoppingList() {
            const container = document.getElementById('shoppingListContainer');
            if (!container || !currentShoppingList) return;

            const itemsByCategory = {};
            currentShoppingList.forEach(item => {
                if (!itemsByCategory[item.category]) {
                    itemsByCategory[item.category] = [];
                }
                itemsByCategory[item.category].push(item);
            });

            const categoryIcons = {
                'produce': 'ü•¨',
                'meat': 'ü•©',
                'dairy': 'ü•õ',
                'grains': 'üåæ',
                'spices': 'üßÇ',
                'pantry': 'üì¶',
                'other': 'üì¶'
            };

            container.innerHTML = Object.entries(itemsByCategory).map(([category, items]) => `
                <div class="shopping-category">
                    <div class="category-header">
                        <span class="category-icon">${categoryIcons[category] || 'üì¶'}</span>
                        <h3 class="category-name">${category.charAt(0).toUpperCase() + category.slice(1)}</h3>
                    </div>
                    <div class="shopping-items">
                        ${items.map((item, idx) => {
                            const globalIndex = currentShoppingList.indexOf(item);
                            return `
                                <div class="shopping-item" data-index="${globalIndex}">
                                    <input type="checkbox" onchange="toggleShoppingItem(this)">
                                    <span class="item-text" onclick="editShoppingItem(${globalIndex})">
                                        ${item.quantity} ${item.unit} ${item.item}
                                    </span>
                                    <div class="item-actions">
                                        <button class="item-action-btn" onclick="editShoppingItem(${globalIndex})" title="Edit">‚úèÔ∏è</button>
                                        <button class="item-action-btn" onclick="deleteShoppingItem(${globalIndex})" title="Delete">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');

            document.getElementById('shoppingListCount').textContent = currentShoppingList.length;
            setTimeout(loadShoppingListState, 0);
        }

        // Edit shopping list item
        async function editShoppingItem(index) {
            const item = currentShoppingList[index];
            const itemEl = document.querySelector(`.shopping-item[data-index="${index}"]`);
            const textSpan = itemEl.querySelector('.item-text');

            const editMode = `
                <div class="item-edit-mode">
                    <input type="number" class="item-edit-input item-quantity-input"
                           value="${item.quantity}" step="0.1" min="0.1" id="edit-qty-${index}">
                    <input type="text" class="item-edit-input"
                           value="${item.unit}" placeholder="unit" id="edit-unit-${index}" style="width: 60px;">
                    <input type="text" class="item-edit-input item-name-input"
                           value="${item.item}" id="edit-name-${index}">
                    <button class="btn btn-small btn-primary" onclick="saveShoppingItem(${index})">‚úì</button>
                    <button class="btn btn-small btn-outline" onclick="renderShoppingList()">‚úï</button>
                </div>
            `;

            textSpan.parentElement.innerHTML = editMode;
            document.getElementById(`edit-name-${index}`).focus();
        }

        // Save edited shopping list item
        async function saveShoppingItem(index) {
            const quantity = parseFloat(document.getElementById(`edit-qty-${index}`).value);
            const name = document.getElementById(`edit-name-${index}`).value.trim();

            if (!name || quantity <= 0) {
                showMessage('Invalid item name or quantity', 'error');
                return;
            }

            try {
                const response = await fetch('/shopping-list/update-item', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ index, quantity, name })
                });

                const data = await response.json();

                if (data.success) {
                    currentShoppingList[index].quantity = data.item.quantity;
                    currentShoppingList[index].item = data.item.item;
                    showMessage('Item updated', 'success');
                    renderShoppingList();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to update item'), 'error');
                }
            } catch (error) {
                showMessage('Error updating item: ' + error.message, 'error');
            }
        }

        // Delete shopping list item
        async function deleteShoppingItem(index) {
            if (!confirm('Delete this item?')) return;

            try {
                const response = await fetch('/shopping-list/delete-item', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ index })
                });

                const data = await response.json();

                if (data.success) {
                    currentShoppingList.splice(index, 1);
                    showMessage('Item deleted', 'success');
                    renderShoppingList();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to delete item'), 'error');
                }
            } catch (error) {
                showMessage('Error deleting item: ' + error.message, 'error');
            }
        }

        // Add custom shopping list item
        function openAddItemModal() {
            const name = prompt('Item name:');
            if (!name || !name.trim()) return;

            const quantity = prompt('Quantity:', '1');
            if (!quantity) return;

            const unit = prompt('Unit (optional):', '');
            const category = prompt('Category (produce/meat/dairy/grains/pantry/spices):', 'other');

            addShoppingItem(name, parseFloat(quantity), unit, category);
        }

        async function addShoppingItem(name, quantity, unit, category) {
            try {
                const response = await fetch('/shopping-list/add-item', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, quantity, unit, category })
                });

                const data = await response.json();

                if (data.success) {
                    currentShoppingList.push(data.item);
                    currentShoppingList.sort((a, b) => {
                        if (a.category !== b.category) return a.category.localeCompare(b.category);
                        return a.item.localeCompare(b.item);
                    });
                    showMessage('Item added', 'success');
                    renderShoppingList();
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to add item'), 'error');
                }
            } catch (error) {
                showMessage('Error adding item: ' + error.message, 'error');
            }
        }

        // Import modal functions
        function openImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            switchImportTab('url');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('importRecipeForm').reset();
            document.getElementById('importTextForm').reset();
            document.getElementById('importPhotoForm').reset();
            document.getElementById('importStatus').classList.add('hidden');
            document.getElementById('importTextStatus').classList.add('hidden');
            document.getElementById('importPhotoStatus').classList.add('hidden');
            document.getElementById('photoPreview').style.display = 'none';
        }

        function switchImportTab(tab) {
            // Update tab buttons
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                if (t.textContent.includes('URL') && tab === 'url') {
                    t.classList.add('active');
                } else if (t.textContent.includes('Text') && tab === 'text') {
                    t.classList.add('active');
                } else if (t.textContent.includes('Photo') && tab === 'photo') {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });

            // Update forms
            const urlForm = document.getElementById('importRecipeForm');
            const textForm = document.getElementById('importTextForm');
            const photoForm = document.getElementById('importPhotoForm');

            urlForm.classList.add('hidden');
            textForm.classList.add('hidden');
            photoForm.classList.add('hidden');

            if (tab === 'url') {
                urlForm.classList.remove('hidden');
            } else if (tab === 'text') {
                textForm.classList.remove('hidden');
            } else if (tab === 'photo') {
                photoForm.classList.remove('hidden');
            }
        }

        // Handle share target query parameters from PWA share
        function handleShareTargetParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const importUrl = urlParams.get('import_url');
            const importText = urlParams.get('import_text');

            if (importUrl) {
                // Auto-open import modal with URL pre-filled
                openImportModal();
                switchImportTab('url');
                document.getElementById('recipeUrl').value = decodeURIComponent(importUrl);
                showMessage('Recipe URL shared to Meal Planner! Click "Import Recipe" to continue.', 'success');

                // Clean up URL without page reload
                window.history.replaceState({}, document.title, '/');
            } else if (importText) {
                // Auto-open import modal with text pre-filled
                openImportModal();
                switchImportTab('text');
                document.getElementById('recipeText').value = decodeURIComponent(importText);
                showMessage('Recipe text shared to Meal Planner! Click "Import from Text" to continue.', 'success');

                // Clean up URL without page reload
                window.history.replaceState({}, document.title, '/');
            }
        }

        // Photo preview
        document.addEventListener('DOMContentLoaded', () => {
            const photoInput = document.getElementById('recipePhoto');
            if (photoInput) {
                photoInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const preview = document.getElementById('photoPreview');
                            const img = document.getElementById('photoPreviewImg');
                            img.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Initialize
            updateScheduleInfo();
            renderWeeklyCalendar();
            renderShoppingList();
            loadShoppingListState();

            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            }

            // Handle share target query parameters
            handleShareTargetParams();

            // Setup touch gestures for swipe navigation
            const calendarEl = document.getElementById('weeklyCalendar');
            calendarEl.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            calendarEl.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });

            // Handle keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (!isPortraitMode()) return;
                if (e.key === 'ArrowLeft') {
                    navigateDay(-1);
                } else if (e.key === 'ArrowRight') {
                    navigateDay(1);
                }
            });

            // Update responsive UI on resize/orientation change
            window.addEventListener('resize', updateResponsiveUI);
            window.addEventListener('orientationchange', () => {
                setTimeout(updateResponsiveUI, 100);
            });
        });

        // Import form handlers
        async function handleImportFormSubmit(event) {
            event.preventDefault();
            const url = document.getElementById('recipeUrl').value;
            const importBtn = document.getElementById('importBtn');
            const statusEl = document.getElementById('importStatus');

            importBtn.disabled = true;
            importBtn.innerHTML = '<span class="loading"></span> Importing...';
            statusEl.className = 'status-message';
            statusEl.textContent = 'Importing recipe...';
            statusEl.classList.remove('hidden');

            try {
                const response = await fetch('/import-recipe', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusEl.className = 'status-message success';
                    statusEl.textContent = data.message;
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    statusEl.className = 'status-message error';
                    statusEl.textContent = data.message || data.error || 'Error importing recipe';
                }
            } catch (error) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'Error: ' + error.message;
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = 'Import Recipe';
            }
        }

        async function handleTextImportFormSubmit(event) {
            event.preventDefault();
            const text = document.getElementById('recipeText').value;
            const importBtn = document.getElementById('importTextBtn');
            const statusEl = document.getElementById('importTextStatus');

            importBtn.disabled = true;
            importBtn.innerHTML = '<span class="loading"></span> Extracting...';
            statusEl.className = 'status-message';
            statusEl.textContent = 'Using AI to extract recipe...';
            statusEl.classList.remove('hidden');

            try {
                const response = await fetch('/import-recipe-text', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text, language: 'auto' })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusEl.className = 'status-message success';
                    statusEl.textContent = data.message;
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    statusEl.className = 'status-message error';
                    statusEl.textContent = data.message || data.error || 'Error importing recipe';
                }
            } catch (error) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'Error: ' + error.message;
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = 'Import from Text';
            }
        }

        async function handlePhotoImportFormSubmit(event) {
            event.preventDefault();
            const fileInput = document.getElementById('recipePhoto');
            const file = fileInput.files[0];
            const importBtn = document.getElementById('importPhotoBtn');
            const statusEl = document.getElementById('importPhotoStatus');

            if (!file) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'Please select an image file';
                statusEl.classList.remove('hidden');
                return;
            }

            // Log file details for debugging
            console.log('[IMAGE UPLOAD] File selected:', {
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: new Date(file.lastModified).toISOString()
            });

            // Check file size (warn if > 10MB)
            if (file.size > 10 * 1024 * 1024) {
                console.warn('[IMAGE UPLOAD] Large file detected:', (file.size / (1024 * 1024)).toFixed(2), 'MB');
            }

            importBtn.disabled = true;
            importBtn.innerHTML = '<span class="loading"></span> Analyzing...';
            statusEl.className = 'status-message';
            statusEl.textContent = 'Using AI to extract recipe from photo... (10-15 seconds)';
            statusEl.classList.remove('hidden');

            try {
                const formData = new FormData();
                formData.append('image', file);
                console.log('[IMAGE UPLOAD] FormData created, starting upload...');

                const response = await fetch('/import-recipe-image', {
                    method: 'POST',
                    body: formData
                });

                console.log('[IMAGE UPLOAD] Response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                const data = await response.json();
                console.log('[IMAGE UPLOAD] Response data:', data);

                if (response.ok && data.success) {
                    statusEl.className = 'status-message success';
                    statusEl.textContent = data.message;
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    statusEl.className = 'status-message error';
                    const errorMsg = data.message || data.error || 'Error importing recipe';
                    statusEl.textContent = errorMsg;
                    console.error('[IMAGE UPLOAD] Error response:', {
                        status: response.status,
                        error: data.error,
                        message: data.message,
                        suggestion: data.suggestion
                    });
                }
            } catch (error) {
                statusEl.className = 'status-message error';
                const errorMsg = 'Error: ' + error.message;
                statusEl.textContent = errorMsg;
                console.error('[IMAGE UPLOAD] Exception caught:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
            } finally {
                importBtn.disabled = false;
                importBtn.innerHTML = 'Import from Photo';
            }
        }

        // Show message function
        function showMessage(message, type = 'success') {
            // Create temporary message
            const messageEl = document.createElement('div');
            messageEl.className = `status-message ${type}`;
            messageEl.textContent = message;
            messageEl.style.position = 'fixed';
            messageEl.style.top = '2rem';
            messageEl.style.right = '2rem';
            messageEl.style.zIndex = '9999';
            messageEl.style.minWidth = '300px';
            messageEl.style.animation = 'slideInRight 0.3s ease';

            document.body.appendChild(messageEl);

            setTimeout(() => {
                messageEl.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => messageEl.remove(), 300);
            }, 3000);
        }

        // Create Recipe modal functions
        function openCreateRecipeModal() {
            document.getElementById('createRecipeModal').classList.remove('hidden');
            // Reset form to initial state with 1 ingredient and 1 instruction
            document.getElementById('createRecipeForm').reset();
            document.getElementById('ingredientsList').innerHTML = '<input type="text" class="ingredient-input" placeholder="e.g., 2 cups chicken breast, diced" required>';
            document.getElementById('instructionsList').innerHTML = '<textarea class="instruction-input" rows="2" placeholder="Step 1: Heat oil in a pan..." required></textarea>';
            document.getElementById('createRecipeStatus').classList.add('hidden');
        }

        function closeCreateRecipeModal() {
            document.getElementById('createRecipeModal').classList.add('hidden');
        }

        function addIngredientField() {
            const list = document.getElementById('ingredientsList');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'ingredient-input';
            input.placeholder = 'e.g., 1 cup water';
            list.appendChild(input);
        }

        function addInstructionField() {
            const list = document.getElementById('instructionsList');
            const textarea = document.createElement('textarea');
            textarea.className = 'instruction-input';
            textarea.rows = 2;
            textarea.placeholder = `Step ${list.children.length + 1}: ...`;
            list.appendChild(textarea);
        }

        async function handleCreateRecipeSubmit(event) {
            event.preventDefault();

            const createBtn = document.getElementById('createRecipeBtn');
            const statusEl = document.getElementById('createRecipeStatus');

            // Gather form data
            const name = document.getElementById('recipeName').value.trim();
            const servings = parseFloat(document.getElementById('recipeServings').value);
            const prepTime = parseInt(document.getElementById('recipePrepTime').value) || 0;
            const cookTime = parseInt(document.getElementById('recipeCookTime').value) || 0;
            const tagsStr = document.getElementById('recipeTags').value.trim();
            const sourceUrl = document.getElementById('recipeSourceUrl').value.trim();
            const imageUrl = document.getElementById('recipeImageUrl').value.trim();

            // Gather ingredients (filter out empty ones)
            const ingredientInputs = document.querySelectorAll('.ingredient-input');
            const ingredients = Array.from(ingredientInputs)
                .map(input => input.value.trim())
                .filter(val => val.length > 0);

            // Gather instructions (filter out empty ones)
            const instructionInputs = document.querySelectorAll('.instruction-input');
            const instructions = Array.from(instructionInputs)
                .map(textarea => textarea.value.trim())
                .filter(val => val.length > 0);

            // Validate
            if (ingredients.length === 0) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'At least one ingredient is required';
                statusEl.classList.remove('hidden');
                return;
            }

            if (instructions.length === 0) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'At least one instruction step is required';
                statusEl.classList.remove('hidden');
                return;
            }

            // Parse tags
            const tags = tagsStr.length > 0
                ? tagsStr.split(',').map(t => t.trim()).filter(t => t.length > 0)
                : ['manual-entry'];

            // Build request body
            const recipeData = {
                name,
                servings,
                prep_time_minutes: prepTime,
                cook_time_minutes: cookTime,
                ingredients,
                instructions,
                tags,
                source_url: sourceUrl || null,
                image_url: imageUrl || null
            };

            // Submit
            createBtn.disabled = true;
            createBtn.innerHTML = '<span class="loading"></span> Creating...';
            statusEl.className = 'status-message';
            statusEl.textContent = 'Creating recipe...';
            statusEl.classList.remove('hidden');

            try {
                const response = await fetch('/recipes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(recipeData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusEl.className = 'status-message success';
                    statusEl.textContent = data.message;
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    statusEl.className = 'status-message error';
                    statusEl.textContent = data.message || data.error || 'Error creating recipe';
                }
            } catch (error) {
                statusEl.className = 'status-message error';
                statusEl.textContent = 'Error: ' + error.message;
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = 'Create Recipe';
            }
        }

        // ============================================
        // Recipe Library - API-based Filtering
        // ============================================

        let currentPage = 1;
        let currentFilters = {
            search: '',
            tags: [],
            sort: ''
        };

        // Fetch and render recipes from API
        async function fetchRecipes(page = 1) {
            const params = new URLSearchParams({
                page: page,
                per_page: 24
            });

            if (currentFilters.search) {
                params.append('search', currentFilters.search);
            }

            if (currentFilters.tags.length > 0) {
                params.append('tags', currentFilters.tags.join(','));
            }

            if (currentFilters.sort) {
                params.append('sort', currentFilters.sort);
            }

            // Show loading state
            document.getElementById('recipeLoading').style.display = 'block';
            document.getElementById('recipeGrid').style.display = 'none';
            document.getElementById('recipeEmpty').style.display = 'none';
            document.getElementById('recipePagination').style.display = 'none';

            try {
                const response = await fetch(`/api/recipes?${params}`);
                const data = await response.json();

                currentPage = page;

                // Update recipe count
                const countEl = document.getElementById('recipeCount');
                countEl.textContent = `${data.pagination.total_recipes} recipe${data.pagination.total_recipes !== 1 ? 's' : ''} found`;

                // Hide loading
                document.getElementById('recipeLoading').style.display = 'none';

                if (data.recipes.length === 0) {
                    // Show empty state
                    document.getElementById('recipeEmpty').style.display = 'block';
                } else {
                    // Render recipes
                    renderRecipes(data.recipes);
                    renderPagination(data.pagination);
                    document.getElementById('recipeGrid').style.display = 'grid';
                    document.getElementById('recipePagination').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error fetching recipes:', error);
                document.getElementById('recipeLoading').style.display = 'none';
                document.getElementById('recipeEmpty').style.display = 'block';
            }
        }

        // Render recipe cards
        function renderRecipes(recipes) {
            const grid = document.getElementById('recipeGrid');

            grid.innerHTML = recipes.map(recipe => {
                // Determine emoji
                let emoji = 'üç≤';
                if (recipe.tags.includes('italian')) emoji = 'üçù';
                else if (recipe.tags.includes('mexican')) emoji = 'üåÆ';
                else if (recipe.tags.includes('asian')) emoji = 'üçú';
                else if (recipe.tags.includes('breakfast')) emoji = 'ü•û';
                else if (recipe.tags.includes('dessert')) emoji = 'üç∞';
                else if (recipe.tags.includes('salad')) emoji = 'ü•ó';

                const imageHtml = recipe.image_url
                    ? `<img src="${recipe.image_url}" alt="${recipe.name}" loading="lazy">`
                    : `<span class="recipe-image-emoji">${emoji}</span>`;

                const timeHtml = recipe.total_time_minutes
                    ? `<span>‚è±Ô∏è ${recipe.total_time_minutes} min</span>`
                    : '';

                const caloriesHtml = recipe.nutrition_per_serving?.calories
                    ? `<span>üî• ${Math.round(recipe.nutrition_per_serving.calories)} cal</span>`
                    : '';

                const tagsHtml = recipe.tags.slice(0, 3).map(tag =>
                    `<span class="tag">${tag}</span>`
                ).join('');

                return `
                    <div class="recipe-card" onclick="window.location.href='/recipe/${recipe.id}'">
                        <div class="recipe-image">
                            ${imageHtml}
                        </div>
                        <div class="recipe-content">
                            <h3 class="recipe-title">${recipe.name}</h3>
                            <div class="recipe-meta">
                                <span>üçΩÔ∏è ${recipe.servings} servings</span>
                                ${timeHtml}
                                ${caloriesHtml}
                            </div>
                            ${tagsHtml ? `<div class="recipe-tags">${tagsHtml}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render pagination controls
        function renderPagination(pagination) {
            const container = document.getElementById('recipePagination');

            if (pagination.total_pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            if (pagination.has_prev) {
                html += `<button class="btn btn-outline btn-small" onclick="fetchRecipes(${pagination.page - 1})">‚Üê Previous</button>`;
            }

            // Page numbers (show max 7 pages)
            const maxVisible = 7;
            let startPage = Math.max(1, pagination.page - Math.floor(maxVisible / 2));
            let endPage = Math.min(pagination.total_pages, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            if (startPage > 1) {
                html += `<button class="btn btn-outline btn-small" onclick="fetchRecipes(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span style="padding: 0 0.5rem; color: var(--color-text-muted);">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                if (i === pagination.page) {
                    html += `<button class="btn btn-primary btn-small">${i}</button>`;
                } else {
                    html += `<button class="btn btn-outline btn-small" onclick="fetchRecipes(${i})">${i}</button>`;
                }
            }

            if (endPage < pagination.total_pages) {
                if (endPage < pagination.total_pages - 1) {
                    html += `<span style="padding: 0 0.5rem; color: var(--color-text-muted);">...</span>`;
                }
                html += `<button class="btn btn-outline btn-small" onclick="fetchRecipes(${pagination.total_pages})">${pagination.total_pages}</button>`;
            }

            // Next button
            if (pagination.has_next) {
                html += `<button class="btn btn-outline btn-small" onclick="fetchRecipes(${pagination.page + 1})">Next ‚Üí</button>`;
            }

            container.innerHTML = html;
        }

        // Apply filters and fetch
        function applyFilters() {
            currentFilters.search = document.getElementById('recipeSearch').value.trim();
            currentFilters.sort = document.getElementById('recipeSort').value;

            // Show/hide clear button
            const clearBtn = document.getElementById('clearSearch');
            clearBtn.style.display = currentFilters.search ? 'block' : 'none';

            fetchRecipes(1);
        }

        // Clear search
        function clearSearch() {
            document.getElementById('recipeSearch').value = '';
            applyFilters();
        }

        // Toggle tag filter
        function toggleTagFilter(button) {
            const tag = button.dataset.tag;
            button.classList.toggle('active');

            if (button.classList.contains('active')) {
                if (!currentFilters.tags.includes(tag)) {
                    currentFilters.tags.push(tag);
                }
            } else {
                currentFilters.tags = currentFilters.tags.filter(t => t !== tag);
            }

            fetchRecipes(1);
        }

        // Clear all tag filters
        function clearAllTags() {
            currentFilters.tags = [];
            document.querySelectorAll('.tag-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            fetchRecipes(1);
        }

        // Reset all filters
        function resetFilters() {
            document.getElementById('recipeSearch').value = '';
            document.getElementById('recipeSort').value = '';
            document.getElementById('clearSearch').style.display = 'none';
            currentFilters = { search: '', tags: [], sort: '' };
            clearAllTags();
        }

        // Search on input with debounce
        let searchDebounce;
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('recipeSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchDebounce);
                    searchDebounce = setTimeout(() => applyFilters(), 300);
                });
            }

            // Load initial recipes
            fetchRecipes(1);
        });
    </script>

    <style>
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</body>
</html>
